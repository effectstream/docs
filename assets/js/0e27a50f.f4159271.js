"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[4635],{2931:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/1205-terminal-8689e6dd78618134a8596028ceae7e3a.png"},2997:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/1205-ui-a02d8446722564d8e42a2ec6680b8fa3.png"},6613:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>d});var i=n(1491);const s={},l=i.createContext(s);function r(e){const t=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(l.Provider,{value:t},e.children)}},8698:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>a,frontMatter:()=>r,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"home/templates/intent-swap","title":"Night-Bitcoin (Intents Swap)","description":"-   Location: /templates/night-bitcoin","source":"@site/docs/home/1200-templates/1205-intent-swap.md","sourceDirName":"home/1200-templates","slug":"/home/templates/intent-swap","permalink":"/docs/home/templates/intent-swap","draft":false,"unlisted":false,"editUrl":"https://github.com/PaimaStudios/paima-engine-docs/tree/main/docs/home/1200-templates/1205-intent-swap.md","tags":[],"version":"current","sidebarPosition":1205,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Multi-Chain Token Swap","permalink":"/docs/home/templates/multi-chain-swap"},"next":{"title":"Tarochi (Game)","permalink":"/docs/home/templates/example-tarochi"}}');var s=n(2531),l=n(6613);const r={},d="Night-Bitcoin (Intents Swap)",c={},o=[{value:"dApp Video:",id:"dapp-video",level:3},{value:"Quick Start",id:"quick-start",level:2},{value:"Concepts",id:"concepts",level:2},{value:"Core Concept: Intent flow overview",id:"core-concept-intent-flow-overview",level:3},{value:"Core Concepts: Effectstream Mapping",id:"core-concepts-effectstream-mapping",level:3},{value:"Background Concepts: The ERC-7683 Standard",id:"background-concepts-the-erc-7683-standard",level:3},{value:"Architecture Overview",id:"architecture-overview",level:2},{value:"The Components in Action",id:"the-components-in-action",level:2},{value:"1. On-Chain Logic",id:"1-on-chain-logic",level:3},{value:"Midnight (Compact)",id:"midnight-compact",level:4},{value:"Bitcoin",id:"bitcoin",level:4},{value:"2. Chain Configuration (<code>localhostConfig.ts</code>)",id:"2-chain-configuration-localhostconfigts",level:3},{value:"Midnight Configuration",id:"midnight-configuration",level:4},{value:"Bitcoin Configuration",id:"bitcoin-configuration",level:4},{value:"3. The State Machine (<code>state-machine.ts</code>)",id:"3-the-state-machine-state-machinets",level:3},{value:"<code>bitcoin-transaction</code>",id:"bitcoin-transaction",level:4},{value:"<code>midnightContractStateERC7683</code>",id:"midnightcontractstateerc7683",level:4},{value:"<code>checkAndTransferFunds</code> (Internal Helper)",id:"checkandtransferfunds-internal-helper",level:4},{value:"4. Fillers (<code>packages/filler</code>)",id:"4-fillers-packagesfiller",level:3},{value:"Embedded Batcher Setup",id:"embedded-batcher-setup",level:4},{value:"Quote Generation Endpoint",id:"quote-generation-endpoint",level:4},{value:"Automated Settlement Execution",id:"automated-settlement-execution",level:4},{value:"5. Database Schema",id:"5-database-schema",level:3},{value:"1. <code>intents</code> Table",id:"1-intents-table",level:4},{value:"2. <code>transfers</code> Table",id:"2-transfers-table",level:4},{value:"3. <code>quotes</code> Table",id:"3-quotes-table",level:4},{value:"Settlement Logic Flow",id:"settlement-logic-flow",level:4},{value:"6. API (<code>api.ts</code>)",id:"6-api-apits",level:3},{value:"Frontend Integration",id:"frontend-integration",level:2}];function h(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",img:"img",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"night-bitcoin-intents-swap",children:"Night-Bitcoin (Intents Swap)"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Location"}),": ",(0,s.jsx)(t.code,{children:"/templates/night-bitcoin"})]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Highlights"}),": Bitcoin & Midnight Interoperability, ERC-7683 Cross-Chain Intents, Solver/Filler Architecture."]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"night-bitcoin"})," template demonstrates a cutting-edge pattern in Web3: ",(0,s.jsx)(t.strong,{children:"Intent-Based Cross-Chain Swaps"}),'. It utilizes Effectstream to orchestrate trades between a UTXO-based chain (Bitcoin) and a ZK-privacy chain (Midnight) without a traditional bridge, relying instead on a network of "Fillers" (Solvers) and an intent standard.']}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Night Bitcoin UI",src:n(2997).A+"",width:"1455",height:"1213"})}),"\n",(0,s.jsx)(t.h3,{id:"dapp-video",children:"dApp Video:"}),"\n",(0,s.jsx)("iframe",{src:"https://drive.google.com/file/d/19rIhqAVBCfjxZrk25xnKU08ffVaCc7RZ/preview",width:"640",height:"480",allow:"autoplay"}),"\n",(0,s.jsx)(t.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Prerequisites"}),":"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"A Midnight Wallet supporting undeployed networks (e.g., Lace Midnight Preview)."}),"\n",(0,s.jsx)(t.li,{children:"A Bitcoin Wallet supporting Regtest (e.g., Sparrow Wallet)."}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sh",children:"# Clone the repository\ngit clone git@github.com:PaimaStudios/paima-engine.git --branch v-next effectstream-demo\ncd effectstream-demo/templates/night-bitcoin\n\n# Check for external dependencies\n./../check.sh\n\n# Install packages\ndeno install --allow-scripts && ./patch.sh\n\n# Compile contracts (Compact for Midnight)\ndeno task build:midnight\ndeno task build:bitcoin\n\n# Launch Effectstream Node\ndeno task dev\n"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Terminal:"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Terminal",src:n(2931).A+"",width:"1722",height:"747"})}),"\n",(0,s.jsxs)(t.p,{children:["Once the ",(0,s.jsx)(t.code,{children:"sync"}),"process starts, open ",(0,s.jsx)(t.a,{href:"http://localhost:10599",children:"http://localhost:10599"})]}),"\n",(0,s.jsx)(t.h2,{id:"concepts",children:"Concepts"}),"\n",(0,s.jsx)(t.h3,{id:"core-concept-intent-flow-overview",children:"Core Concept: Intent flow overview"}),"\n",(0,s.jsxs)(t.p,{children:["Instead of executing a direct transaction to swap tokens, users sign an ",(0,s.jsx)(t.strong,{children:"Intent"}),"\u2014a message declaring ",(0,s.jsx)(t.em,{children:"what"}),' they want (e.g., "I offer 1 BTC to receive at least 1000 M20 on Midnight").']}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"Note Fillers and Solvers are the same in this example."}),"\n"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Request Quote"}),": The user requests quotes from off-chain Fillers."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Create Intent"}),": The user selects the best quote and creates an Intent on the Midnight chain (using the ERC-7683 standard contract)."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Payment"}),": The user sends the source funds (BTC) to the verifier nodes/escrow."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Verification"}),": The verifier nodes monitor the blockchains. When it detects the Intent on Midnight ",(0,s.jsx)(t.em,{children:"and"})," the Payment on Bitcoin, it matches them."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Filler Execution"}),": The Fillers read the Intent and provides the liquidity, sending the funds to the user."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Resolution"}),": The Verifier Nodes validates the trade and triggers the release of funds to the user and the Fillers."]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"core-concepts-effectstream-mapping",children:"Core Concepts: Effectstream Mapping"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"The Verifier Nodes -> is implemented an Effectstream State Machine."}),"\n",(0,s.jsx)(t.li,{children:"The Fillers -> is implemented as a Effectstream Batcher."}),"\n",(0,s.jsx)(t.li,{children:"ERC-7683 Contract -> Midnight Contract"}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Once the process starts, open ",(0,s.jsx)(t.a,{href:"http://localhost:10599",children:"http://localhost:10599"}),"."]}),"\n",(0,s.jsx)(t.h3,{id:"background-concepts-the-erc-7683-standard",children:"Background Concepts: The ERC-7683 Standard"}),"\n",(0,s.jsxs)(t.p,{children:["This template leverages ",(0,s.jsx)(t.strong,{children:"ERC-7683"}),", a standard interface for cross-chain trade execution systems."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"The Problem"}),'\nIntent-based systems abstract away the complexity of bridges for users, but they often suffer from fragmented liquidity and isolated networks of "fillers" (solvers). Each protocol usually builds its own proprietary ',(0,s.jsx)(t.code,{children:"order"})," format, making it difficult for fillers to support multiple chains and dApps efficiently."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"The Solution"}),"\nERC-7683 establishes a framework for specifying cross-chain actions. By standardizing the ",(0,s.jsx)(t.code,{children:"order"})," structure and the settlement interfaces, it allows diverse systems to share infrastructure."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"In Night-Bitcoin"}),'\nWe utilize this standard to define the "Swap Intent" on the Midnight chain. Even though one side of the transaction occurs on Bitcoin (which is non-EVM), the ',(0,s.jsx)(t.strong,{children:"Midnight contract"})," acts as the ",(0,s.jsx)(t.code,{children:"OriginSettler"})," defined in the spec. In this example, we take a simplified approach to the settlement interfaces and resolutions."]}),"\n",(0,s.jsx)(t.h2,{id:"architecture-overview",children:"Architecture Overview"}),"\n",(0,s.jsx)(t.mermaid,{value:"sequenceDiagram\n    participant User\n    participant Fillers\n    participant Midnight (ERC-7683)\n    participant Bitcoin\n    participant Effectstream Node\n\n    User->>Fillers: Request Quote (BTC -> M20)\n    Fillers->>User: Return Quotes (Price + Fee)\n    User->>Midnight (ERC-7683): Submit Intent (Initialize)\n    User->>Bitcoin: Send BTC Payment (Lock in Escrow)\n    \n    par Sync & Match\n        Bitcoin--\x3e>Effectstream Node: Detect Transaction\n        Midnight (ERC-7683)--\x3e>Effectstream Node: Detect Intent Created\n    end\n\n    Effectstream Node->>Effectstream Node: Match Payment to Intent\n    Effectstream Node--)Fillers: Broadcast Verification (BTC Secured)\n    \n    par Fulfillment\n        Fillers->>User: Payout M20 (on Midnight)\n        Fillers->>Midnight (ERC-7683): Call Resolve (Submit Proof)\n    end\n\n    Midnight (ERC-7683)--\x3e>Effectstream Node: Detect Resolve Event\n    \n    Note over Effectstream Node, Bitcoin: Settlement\n    Effectstream Node->>Fillers: Release BTC (on Bitcoin)"}),"\n",(0,s.jsx)(t.h2,{id:"the-components-in-action",children:"The Components in Action"}),"\n",(0,s.jsx)(t.h3,{id:"1-on-chain-logic",children:"1. On-Chain Logic"}),"\n",(0,s.jsx)(t.h4,{id:"midnight-compact",children:"Midnight (Compact)"}),"\n",(0,s.jsxs)(t.p,{children:["The template uses two main contracts located in ",(0,s.jsx)(t.code,{children:"packages/shared/contracts/midnight-contracts"}),":"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"erc7683.compact"})}),": Implements the standard for Cross-Chain Intents. It stores the ",(0,s.jsx)(t.code,{children:"Intent"})," struct containing details like ",(0,s.jsx)(t.code,{children:"maxSpent"}),", ",(0,s.jsx)(t.code,{children:"minReceived"}),", and other standard fields."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"unshielded-erc20.compact"})}),': Openzepplin Standard ERC20 Unshielded "M20" token used for swapping against Bitcoin.']}),"\n"]}),"\n",(0,s.jsx)(t.h4,{id:"bitcoin",children:"Bitcoin"}),"\n",(0,s.jsx)(t.p,{children:"There are no smart contracts on Bitcoin. Instead, the engine tracks specific addresses and transaction inputs/outputs using the Bitcoin RPC."}),"\n",(0,s.jsxs)(t.h3,{id:"2-chain-configuration-localhostconfigts",children:["2. Chain Configuration (",(0,s.jsx)(t.code,{children:"localhostConfig.ts"}),")"]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"localhostConfig"})," connects the engine to a local Bitcoin Regtest node and a local Midnight node."]}),"\n",(0,s.jsx)(t.h4,{id:"midnight-configuration",children:"Midnight Configuration"}),"\n",(0,s.jsx)(t.p,{children:"This block configures the connection to the local Midnight node, the Indexer sync protocol, and the primitives that monitor the public state of the ZK contracts."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:'// 1. Network Definition\n.addNetwork({\n  name: "midnight",\n  type: ConfigNetworkType.MIDNIGHT,\n  genesisHash: "0x0000...0001",\n  networkId: 0, // 0 = Undeployed/Local\n  nodeUrl: "http://127.0.0.1:9944",\n})\n\n// 2. Sync Protocol (via Indexer)\n.addParallel(\n  (networks) => networks.midnight,\n  (network, deployments) => ({\n    name: "parallelMidnight",\n    type: ConfigSyncProtocolType.MIDNIGHT_PARALLEL,\n    pollingInterval: 1000,\n    indexer: "http://127.0.0.1:8088/api/v1/graphql",\n    indexerWs: "ws://127.0.0.1:8088/api/v1/graphql/ws",\n  })\n)\n\n// 3. Primitives (Contract State Listeners)\n.addPrimitive(\n  (syncProtocols) => syncProtocols.parallelMidnight,\n  (network, deployments, syncProtocol) => ({\n    name: "MidnightContractState-ERC7683",\n    type: PrimitiveTypeMidnightGeneric,\n    contractAddress: readMidnightContract("erc7683", "contract-erc7683.json").contractAddress,\n    stateMachinePrefix: "midnightContractStateERC7683",\n    contract: { ledger: Erc7683Contract.ledger },\n  })\n)\n.addPrimitive(\n  (syncProtocols) => syncProtocols.parallelMidnight,\n  (network, deployments, syncProtocol) => ({\n    name: "MidnightContractState-ERC20",\n    type: PrimitiveTypeMidnightGeneric,\n    contractAddress: readMidnightContract("unshielded-erc20", "contract-unshielded-erc20.json").contractAddress,\n    stateMachinePrefix: "midnightContractStateERC20",\n    contract: { ledger: UnshieldedErc20Contract.ledger },\n  })\n)\n'})}),"\n",(0,s.jsx)(t.h4,{id:"bitcoin-configuration",children:"Bitcoin Configuration"}),"\n",(0,s.jsx)(t.p,{children:"This block configures the connection to the local Bitcoin Core node (Regtest), the RPC sync protocol, and the primitive that watches specific UTXOs."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:'// 1. Network Definition\n.addNetwork({\n  name: "bitcoin",\n  type: ConfigNetworkType.BITCOIN,\n  rpcUrl: "http://127.0.0.1:18443",\n  rpcAuth: {\n    username: "dev",\n    password: "devpassword",\n  },\n  network: "regtest",\n})\n\n// 2. Sync Protocol (via RPC)\n.addParallel(\n  (networks) => networks.bitcoin,\n  (network, deployments) => ({\n    name: "parallelBitcoin",\n    type: ConfigSyncProtocolType.BITCOIN_RPC_PARALLEL,\n    rpcUrl: "http://127.0.0.1:18443",\n    pollingInterval: 10_000,\n    confirmationDepth: 0, // 0 for faster dev on regtest\n  })\n)\n\n// 3. Primitive (Address Watcher)\n.addPrimitive(\n  (syncProtocols) => syncProtocols.parallelBitcoin,\n  (network, deployments, syncProtocol) => ({\n    name: "BitcoinAddress",\n    type: PrimitiveTypeBitcoinAddress,\n    startBlockHeight: 101,\n    // The Escrow/System wallet address to watch for payments\n    watchAddress: "bcrt1qfv6m6l5s6cgda09yr5nd8rnufkaz59d3aquq03",\n    stateMachinePrefix: "bitcoin-transaction",\n  })\n)\n'})}),"\n",(0,s.jsxs)(t.h3,{id:"3-the-state-machine-state-machinets",children:["3. The State Machine (",(0,s.jsx)(t.code,{children:"state-machine.ts"}),")"]}),"\n",(0,s.jsxs)(t.p,{children:["The logic is driven by three main ",(0,s.jsx)(t.code,{children:"State Transition Functions"}),":\nThis implements a simplified the Verifier/Settlement layer."]}),"\n",(0,s.jsx)(t.h4,{id:"bitcoin-transaction",children:(0,s.jsx)(t.code,{children:"bitcoin-transaction"})}),"\n",(0,s.jsxs)(t.p,{children:["Triggered when funds move on the watched ",(0,s.jsx)(t.code,{children:"Bitcoin address"}),"."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Records the transfer in the ",(0,s.jsx)(t.code,{children:"transfers"})," database table."]}),"\n",(0,s.jsxs)(t.li,{children:["Calls ",(0,s.jsx)(t.code,{children:"checkAndTransferFunds"})," to see if this payment matches a known Intent from Midnight."]}),"\n"]}),"\n",(0,s.jsx)(t.h4,{id:"midnightcontractstateerc7683",children:(0,s.jsx)(t.code,{children:"midnightContractStateERC7683"})}),"\n",(0,s.jsxs)(t.p,{children:["Triggered when the Midnight ",(0,s.jsx)(t.code,{children:"Intent"})," contract state changes."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Decodes the ",(0,s.jsx)(t.code,{children:"Intent"})," struct from the public ledger."]}),"\n",(0,s.jsxs)(t.li,{children:["Records the intent in the ",(0,s.jsx)(t.code,{children:"intents"})," database table."]}),"\n",(0,s.jsxs)(t.li,{children:["Calls ",(0,s.jsx)(t.code,{children:"checkAndTransferFunds"})," to see if the payment for this intent has already arrived."]}),"\n"]}),"\n",(0,s.jsxs)(t.h4,{id:"checkandtransferfunds-internal-helper",children:[(0,s.jsx)(t.code,{children:"checkAndTransferFunds"})," (Internal Helper)"]}),"\n",(0,s.jsxs)(t.p,{children:["This is the core settlement logic, it is called if a new ",(0,s.jsx)(t.code,{children:"Intent"})," is created or a new ",(0,s.jsx)(t.code,{children:"BTC Payment"})," or ",(0,s.jsx)(t.code,{children:"Midnight M20 Payment"}),"."]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["It queries the database to find a ",(0,s.jsx)(t.code,{children:"transfers"})," record and an ",(0,s.jsx)(t.code,{children:"intents"})," record that match (based on amounts and tokens)."]}),"\n",(0,s.jsxs)(t.li,{children:["If matched, it updates the status to ",(0,s.jsx)(t.code,{children:"Resolved"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["Notifies the Fillers that the ",(0,s.jsx)(t.code,{children:"Intent"})," has been matched and the ",(0,s.jsx)(t.code,{children:"BTC Payment"})," has been secured."]}),"\n",(0,s.jsx)(t.li,{children:"It triggers the settlement payouts (sending M20 to the User and BTC to the Filler)."}),"\n"]}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsxs)(t.p,{children:["NOTE: In complete implementation step (3) would require the Filler to again check if the ",(0,s.jsx)(t.code,{children:"Intent"})," is valid, and then provide liquidity and mark and ",(0,s.jsx)(t.code,{children:"resolve"})," the intent, and then the ",(0,s.jsx)(t.code,{children:"Verifier Nodes"})," would work as the ",(0,s.jsx)(t.code,{children:"Settler"})," to release the funds to the filler."]}),"\n"]}),"\n",(0,s.jsxs)(t.h3,{id:"4-fillers-packagesfiller",children:["4. Fillers (",(0,s.jsx)(t.code,{children:"packages/filler"}),")"]}),"\n",(0,s.jsxs)(t.p,{children:["The template includes a standalone service that simulates a market of Liquidity Providers. Unlike simple market makers, these Fillers are ",(0,s.jsx)(t.strong,{children:"active agents"})," that integrate an embedded ",(0,s.jsx)(t.strong,{children:"Batcher"})," to automate the settlement process."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Location"}),": ",(0,s.jsx)(t.code,{children:"packages/filler"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Orchestration"}),": The orchestrator launches multiple instances (Alpha Liquidity, Omega Swap, etc.) on different ports to simulate a competitive market."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Embedded Batcher"}),": Each Filler initializes its own Batcher instance connected to both Bitcoin and Midnight adapters. This allows the Filler to programmatically sign and submit transactions to either chain without manual intervention."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"API Endpoints"}),":","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"POST /api/quote"}),": Used by the Frontend to request competitive exchange rates and fees before creating an Intent."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"POST /api/notify-filler-intent-payment"}),": Used by the Effectstream Node (State Machine) to notify the Filler that a user's payment has been verified. Upon receiving this webhook, the Filler automatically queues a transaction via its internal Batcher to pay the user the requested tokens (M20 or BTC)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h4,{id:"embedded-batcher-setup",children:"Embedded Batcher Setup"}),"\n",(0,s.jsx)(t.p,{children:"Each filler initializes its own Paima Batcher instance. This allows the filler to programmatically execute transactions on both Bitcoin and Midnight using its own unique wallet seeds."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'// packages/filler/index.ts\n\n// 1. Build the Batcher setup with the filler\'s specific credentials\nconst batcherSetup = buildBatcherSetup({\n  fillerName: FILLER_NAME,\n  midnightSeed: FILLER_BATCHER_DEFAULTS.midnightSeed, // Unique seed per filler\n  bitcoin: { ...FILLER_BATCHER_DEFAULTS.bitcoin },\n  // ...\n});\n\n// 2. Initialize the Batcher with dual adapters\nconst batcher = createNewBatcher(batcherSetup.config, batcherSetup.storage);\n\nbatcher\n  .addBlockchainAdapter("midnight", batcherSetup.adapters.midnight, { \n    criteriaType: "size", maxBatchSize: 1 // Execute immediately\n  })\n  .addBlockchainAdapter("bitcoin", batcherSetup.adapters.bitcoin, {\n    criteriaType: "hybrid", timeWindowMs: 1000\n  })\n  .setDefaultTarget("midnight");\n'})}),"\n",(0,s.jsx)(t.h4,{id:"quote-generation-endpoint",children:"Quote Generation Endpoint"}),"\n",(0,s.jsx)(t.p,{children:"The filler provides a standard API for the frontend to fetch competitive rates."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'// packages/filler/index.ts\n\nserver.post("/api/quote", async (request, reply) => {\n  const { orderId, fromToken, toToken, fromAmount } = request.body;\n\n  // Calculate custom rate and fee\n  const conversionRate = getConversion(fromAmount, fromToken, toToken);\n  const fee = (basisPoints * conversionRate) / 10000;\n\n  // Return the signed quote structure\n  reply.send({\n    orderId,\n    filler: FILLER_NAME,\n    toAmount: conversionRate - fee,\n    fee,\n    // ...\n  });\n});\n'})}),"\n",(0,s.jsx)(t.h4,{id:"automated-settlement-execution",children:"Automated Settlement Execution"}),"\n",(0,s.jsx)(t.p,{children:"When the Effectstream Node verifies the user's payment, it notifies the filler that provided the quote. The filler then uses its embedded batcher to automatically send the counter-assets to the user."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'// packages/filler/index.ts\n\nserver.post("/api/notify-filler-intent-payment", async (request, reply) => {\n  const { orderId, toAddress, amount, token } = request.body;\n  \n  // Programmatically trigger the Batcher to send funds\n  if (token === "btc") {\n    await batcher.batchInput({\n      address: "filler-btc-wallet", \n      input: JSON.stringify({\n         type: "transfer",\n         toAddress: toAddress,\n         amount: Math.floor(amount)\n      }),\n      target: "bitcoin" // Route to Bitcoin Adapter\n    });\n  } \n  else if (token === "m20") {\n     await batcher.batchInput({\n        address: "filler-midnight-wallet",\n        addressType: AddressType.MIDNIGHT,\n        input: JSON.stringify({\n           type: "transfer",\n           toAddress: toAddress,\n           amount: Math.floor(amount)\n        }),\n        target: "midnight" // Route to Midnight Adapter\n     });\n  }\n  \n  reply.send({ status: "processing", orderId });\n});\n'})}),"\n",(0,s.jsx)(t.h3,{id:"5-database-schema",children:"5. Database Schema"}),"\n",(0,s.jsx)(t.p,{children:"The database acts as the central clearinghouse state for the application. It persists the competitive quotes from fillers, tracks raw asset movements across Bitcoin and Midnight, and maintains the authoritative state of the ERC-7683 Intents."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"intents"})}),": Stores ERC-7683 Intent data (Order ID, deadlines, assets involved)."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"transfers"})}),": Stores raw on-chain transfers detected (Chain ID, Amount, Token)."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"quotes"})}),": Stores the quotes provided by fillers for audit trails."]}),"\n"]}),"\n",(0,s.jsxs)(t.h4,{id:"1-intents-table",children:["1. ",(0,s.jsx)(t.code,{children:"intents"})," Table"]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Purpose"}),": Stores the authoritative state of every ERC-7683 Intent created on the Midnight chain. This table mirrors the ",(0,s.jsx)(t.code,{children:"ResolvedCrossChainOrder"})," struct defined in the standard."]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Field"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Usage & Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"order_id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,s.jsx)(t.strong,{children:"Unique Key"}),". The global identifier for the swap order, derived from the user's signature/intent hash."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"status"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Tracks the lifecycle: ",(0,s.jsx)(t.code,{children:"'0'"})," (Open/Initialized), ",(0,s.jsx)(t.code,{children:"'3'"})," (Resolved/Closed). Updated by the State Machine upon settlement."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"user_address"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The Midnight address of the user initiating the swap."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"max_spent_token"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The asset the user is selling (e.g., "btc").'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"max_spent_amount"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The amount the user must deposit to the escrow address (e.g., Satoshis)."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"min_received_token"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The asset the user expects to receive (e.g., "m20").'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"min_received_amount"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The guaranteed amount the user will receive on the destination chain."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"origin_data"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Additional data defined by the Origin chain (Midnight), often containing target wallet info for the Fillers."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"created_at"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TIMESTAMP"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Timestamp of when the intent was created."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"origin_chain_id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The chain ID of the origin chain (e.g., "1" for Bitcoin, "9999" for Midnight).'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"open_deadline"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The deadline for the user to open the intent."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"fill_deadline"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The deadline for the filler to fill the intent."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"max_spent_recipient"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The recipient address of the user."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"max_spent_chain_id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The chain ID of the origin chain (e.g., "1" for Bitcoin, "9999" for Midnight).'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"min_received_recipient"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The recipient address of the user."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"min_received_chain_id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The chain ID of the destination chain (e.g., "9999" for Midnight).'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"destination_chain_id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The chain ID of the destination chain (e.g., "9999" for Midnight).'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"destination_settler"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The address of the destination settler."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"resolved_by"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Populated during settlement. Stores the ID of the Filler who successfully claimed and executed this order."})]})]})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsxs)(t.h4,{id:"2-transfers-table",children:["2. ",(0,s.jsx)(t.code,{children:"transfers"})," Table"]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Purpose"}),": A unified ledger of ",(0,s.jsx)(t.strong,{children:"raw asset movements"})," detected on ",(0,s.jsx)(t.em,{children:"both"})," Bitcoin and Midnight. The State Machine scans this table to find payments that match open intents."]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Field"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Usage & Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"SERIAL"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The unique identifier for the transfer."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"chain_id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Distinguishes the network source: ",(0,s.jsx)(t.code,{children:"'1'"})," for Bitcoin, ",(0,s.jsx)(t.code,{children:"'9999'"})," for Midnight."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"token"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The asset symbol (e.g., "btc", "m20").'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"amount"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"NUMERIC"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The raw value transferred."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"created_at"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TIMESTAMP"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Timestamp of when the transfer was created."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"to_address"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The recipient address. For valid swaps, this must match the System/Escrow address monitored by Paima."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"from_address"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The sender's address."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"used"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"BOOLEAN"})}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,s.jsx)(t.strong,{children:"Critical Field"}),". Acts as a semaphore. When the State Machine matches a transfer to an intent, it sets this to ",(0,s.jsx)(t.code,{children:"TRUE"})," to prevent the same deposit from satisfying multiple orders."]})]})]})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsxs)(t.h4,{id:"3-quotes-table",children:["3. ",(0,s.jsx)(t.code,{children:"quotes"})," Table"]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Purpose"}),": An audit trail of the off-chain negotiation phase. It records the offers provided by Fillers ",(0,s.jsx)(t.em,{children:"before"})," the Intent was created on-chain."]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Field"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Usage & Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"SERIAL"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The unique identifier for the quote."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"order_id"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Links this quote to the finalized Intent in the ",(0,s.jsx)(t.code,{children:"intents"})," table."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"filler"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The name or ID of the Filler providing the quote (e.g., "Alpha Liquidity").'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"from_token"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The asset the user is selling (e.g., "btc").'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"from_amount"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"NUMERIC"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The amount the user must deposit to the escrow address"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"to_token"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TEXT"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'The asset the user expects to receive (e.g., "m20").'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"to_amount"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"NUMERIC"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The amount the Filler offered to pay the user (Price)."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"fee"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"NUMERIC"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The service fee charged by the filler."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"created_at"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"TIMESTAMP"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Timestamp of when the quote was generated via the API."})]})]})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h4,{id:"settlement-logic-flow",children:"Settlement Logic Flow"}),"\n",(0,s.jsx)(t.p,{children:"The State Machine uses these tables to perform atomic settlement:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Ingestion"}),":","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"intents"})," is populated by the ",(0,s.jsx)(t.code,{children:"midnightContractStateERC7683"})," primitive when a user submits an intent."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"transfers"})," is populated by the ",(0,s.jsx)(t.code,{children:"BitcoinAddress"})," primitive when BTC arrives."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Matching (State Machine)"}),":","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["It queries for an ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"intent"})})," where ",(0,s.jsx)(t.code,{children:"status = '0'"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["It queries for a ",(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"transfer"})})," where ",(0,s.jsx)(t.code,{children:"amount >= intent.max_spent_amount"})," AND ",(0,s.jsx)(t.code,{children:"token == intent.max_spent_token"})," AND ",(0,s.jsx)(t.code,{children:"used = FALSE"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Resolution"}),":","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["If a match is found, it locks the transfer (",(0,s.jsx)(t.code,{children:"UPDATE transfers SET used = TRUE"}),")."]}),"\n",(0,s.jsxs)(t.li,{children:["It marks the intent as resolved (",(0,s.jsx)(t.code,{children:"UPDATE intents SET status = '3'"}),")."]}),"\n",(0,s.jsxs)(t.li,{children:["It looks up the winning ",(0,s.jsx)(t.code,{children:"quote"})," using the ",(0,s.jsx)(t.code,{children:"order_id"})," to determine which Filler to pay."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.h3,{id:"6-api-apits",children:["6. API (",(0,s.jsx)(t.code,{children:"api.ts"}),")"]}),"\n",(0,s.jsx)(t.p,{children:"The API layer aggregates data for the Frontend:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"POST /api/get-quotes"}),": Proxies requests to the active Filler services to get the best price for the user."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"GET /api/intents"}),": Returns the status of a specific Order ID."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"GET /api/faucet/btc"})," & ",(0,s.jsx)(t.code,{children:"/api/faucet/dust"}),": Development endpoints to fund test wallets."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"frontend-integration",children:"Frontend Integration"}),"\n",(0,s.jsxs)(t.p,{children:["The frontend (",(0,s.jsx)(t.code,{children:"packages/frontend/dApp"}),") is a React application that:"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Connects to a ",(0,s.jsx)(t.strong,{children:"Midnight Wallet"})," (Lace) to sign Intents."]}),"\n",(0,s.jsxs)(t.li,{children:["Connects to a ",(0,s.jsx)(t.strong,{children:"Bitcoin Wallet"})," (via manual address entry for this demo) to send payments."]}),"\n",(0,s.jsxs)(t.li,{children:["Interacts with the ",(0,s.jsx)(t.strong,{children:"Fillers"})," to fetch quotes."]}),"\n",(0,s.jsxs)(t.li,{children:["Monitors the ",(0,s.jsx)(t.strong,{children:"Effectstream API"})," to track the status of the swap."]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-tsx",children:'// Example: Creating an intent on Midnight\nconst intentConfig = {\n  user: midnightWallet.addr,\n  orderId: selectedQuote.orderId,\n  maxSpent_token: "btc",\n  minReceived_token: "m20",\n  // ...\n};\nconst intentResult = await interface.createIntent(\n    midnightWallet.contract.erc7683, \n    midnightWallet.addr, \n    intentConfig\n);\n'})})]})}function a(e={}){const{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);