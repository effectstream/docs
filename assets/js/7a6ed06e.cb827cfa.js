"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[5711],{4058:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"home/components/batcher/advanced-topics","title":"Advanced Topics","description":"Overview","source":"@site/docs/home/100-components/108-batcher/1290-advanced-topics.md","sourceDirName":"home/100-components/108-batcher","slug":"/home/components/batcher/advanced-topics","permalink":"/docs/home/components/batcher/advanced-topics","draft":false,"unlisted":false,"editUrl":"https://github.com/PaimaStudios/paima-engine-docs/tree/main/docs/home/100-components/108-batcher/1290-advanced-topics.md","tags":[],"version":"current","sidebarPosition":1290,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Custom Adapters","permalink":"/docs/home/components/batcher/adapter"},"next":{"title":"Database","permalink":"/docs/home/components/database"}}');var s=t(2531),i=t(6613);const a={},c="Advanced Topics",l={},o=[{value:"Overview",id:"overview",level:2},{value:"Target Audience",id:"target-audience",level:2},{value:"HTTP API",id:"http-api",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Endpoints",id:"endpoints",level:3},{value:"1. <code>POST /send-input</code> \u2013 Submit User Input",id:"1-post-send-input--submit-user-input",level:4},{value:"2. <code>GET /status</code> \u2013 Batcher Status",id:"2-get-status--batcher-status",level:4},{value:"3. <code>GET /queue-stats</code> \u2013 Queue Statistics",id:"3-get-queue-stats--queue-statistics",level:4},{value:"4. <code>POST /force-batch</code> \u2013 Force Batch Processing (Developer)",id:"4-post-force-batch--force-batch-processing-developer",level:4},{value:"5. <code>GET /health</code> \u2013 Health Check",id:"5-get-health--health-check",level:4},{value:"6. <code>DELETE /clear-inputs</code> \u2013 Clear Pending Inputs (Developer)",id:"6-delete-clear-inputs--clear-pending-inputs-developer",level:4},{value:"OpenAPI Documentation",id:"openapi-documentation",level:3},{value:"Batching Criteria",id:"batching-criteria",level:2},{value:"Configuration Structure",id:"configuration-structure",level:3},{value:"Criteria Types",id:"criteria-types",level:3},{value:"1. Time-Based Criteria",id:"1-time-based-criteria",level:4},{value:"2. Size-Based Criteria",id:"2-size-based-criteria",level:4},{value:"3. Value-Based Criteria",id:"3-value-based-criteria",level:4},{value:"4. Hybrid Criteria",id:"4-hybrid-criteria",level:4},{value:"5. Custom Criteria",id:"5-custom-criteria",level:4},{value:"Batching Criteria Best Practices",id:"batching-criteria-best-practices",level:3},{value:"Event System",id:"event-system",level:2},{value:"Enabling Events",id:"enabling-events",level:3},{value:"Adding Event Listeners",id:"adding-event-listeners",level:3},{value:"Available Events",id:"available-events",level:3},{value:"1. <code>startup</code> \u2013 Batcher Initialization",id:"1-startup--batcher-initialization",level:4},{value:"2. <code>http:start</code> \u2013 HTTP Server Started",id:"2-httpstart--http-server-started",level:4},{value:"3. <code>http:stop</code> \u2013 HTTP Server Stopped",id:"3-httpstop--http-server-stopped",level:4},{value:"4. <code>poll:targets-ready</code> \u2013 Targets Ready for Batching",id:"4-polltargets-ready--targets-ready-for-batching",level:4},{value:"5. <code>batch:process:start</code> \u2013 Batch Processing Started",id:"5-batchprocessstart--batch-processing-started",level:4},{value:"6. <code>batch:fee-estimate</code> \u2013 Fee Estimated",id:"6-batchfee-estimate--fee-estimated",level:4},{value:"7. <code>batch:submit</code> \u2013 Batch Submitted to Blockchain",id:"7-batchsubmit--batch-submitted-to-blockchain",level:4},{value:"8. <code>batch:receipt</code> \u2013 Transaction Confirmed",id:"8-batchreceipt--transaction-confirmed",level:4},{value:"9. <code>batch:effectstream-processed</code> \u2013 Paima Engine Processed",id:"9-batcheffectstream-processed--paima-engine-processed",level:4},{value:"10. <code>batch:process:end</code> \u2013 Batch Processing Complete",id:"10-batchprocessend--batch-processing-complete",level:4},{value:"11. <code>error</code> \u2013 Error Occurred",id:"11-error--error-occurred",level:4},{value:"Event System Best Practices",id:"event-system-best-practices",level:3},{value:"1. Use for Observability",id:"1-use-for-observability",level:4},{value:"2. Error Handling in Listeners",id:"2-error-handling-in-listeners",level:4},{value:"3. Prevent Duplicate Listeners",id:"3-prevent-duplicate-listeners",level:4},{value:"4. Complete Monitoring Example",id:"4-complete-monitoring-example",level:4},{value:"Storage System",id:"storage-system",level:2},{value:"The <code>BatcherStorage</code> Interface",id:"the-batcherstorage-interface",level:3},{value:"Built-in: <code>FileStorage</code>",id:"built-in-filestorage",level:3},{value:"Custom Storage Implementations",id:"custom-storage-implementations",level:3},{value:"Example: PostgreSQL Storage",id:"example-postgresql-storage",level:4},{value:"Example: Redis Storage",id:"example-redis-storage",level:4},{value:"Storage Best Practices",id:"storage-best-practices",level:3},{value:"1. Choose Based on Scale",id:"1-choose-based-on-scale",level:4},{value:"2. Ensure Atomicity",id:"2-ensure-atomicity",level:4},{value:"3. Handle Crashes Gracefully",id:"3-handle-crashes-gracefully",level:4},{value:"4. Monitor Storage Health",id:"4-monitor-storage-health",level:4},{value:"5. Implement Backup/Restore",id:"5-implement-backuprestore",level:4},{value:"Effection Integration",id:"effection-integration",level:2},{value:"What is Effection?",id:"what-is-effection",level:3},{value:"Why Use Effection with the Batcher?",id:"why-use-effection-with-the-batcher",level:3},{value:"Installation",id:"installation",level:3},{value:"Using <code>runBatcher()</code> with Effection",id:"using-runbatcher-with-effection",level:3},{value:"Basic Example",id:"basic-example",level:4},{value:"Complete Example with Event Listeners",id:"complete-example-with-event-listeners",level:3},{value:"Alternative: Manual Initialization",id:"alternative-manual-initialization",level:3},{value:"Graceful Shutdown with Effection",id:"graceful-shutdown-with-effection",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"Running Multiple Batchers",id:"running-multiple-batchers",level:3},{value:"Effection Operations Reference",id:"effection-operations-reference",level:3},{value:"<code>runBatcher(): Operation&lt;void&gt;</code>",id:"runbatcher-operationvoid",level:4},{value:"<code>runHttpServer(): Operation&lt;void&gt;</code>",id:"runhttpserver-operationvoid",level:4},{value:"<code>runPollingLoop(): Operation&lt;void&gt;</code>",id:"runpollingloop-operationvoid",level:4},{value:"<code>gracefulShutdownOp(hooks?, options?): Operation&lt;void&gt;</code>",id:"gracefulshutdownophooks-options-operationvoid",level:4},{value:"<code>emitStateTransition(prefix, payload): Operation&lt;void&gt;</code>",id:"emitstatetransitionprefix-payload-operationvoid",level:4},{value:"Best Practices",id:"best-practices",level:3},{value:"1. Always Use <code>main()</code> for Production",id:"1-always-use-main-for-production",level:4},{value:"2. Use <code>spawn()</code> for Background Tasks",id:"2-use-spawn-for-background-tasks",level:4},{value:"3. Handle Errors Gracefully",id:"3-handle-errors-gracefully",level:4},{value:"4. Add Event Listeners Before Starting",id:"4-add-event-listeners-before-starting",level:4},{value:"Comparison: Effection vs Manual Async/Await",id:"comparison-effection-vs-manual-asyncawait",level:3},{value:"Summary",id:"summary",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"advanced-topics",children:"Advanced Topics"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"This guide covers advanced features of the Batcher that provide powerful customization, monitoring, and operational capabilities:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"HTTP API"}),": REST endpoints for submitting inputs and monitoring system status"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Batching Criteria"}),": Advanced strategies for controlling when batches are submitted"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Event System"}),": Lifecycle hooks for observability and custom behavior"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Storage System"}),": Pluggable persistence layer for crash-safe operation"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"target-audience",children:"Target Audience"}),"\n",(0,s.jsx)(n.p,{children:"Developers who need to:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Interact with the batcher programmatically via HTTP"}),"\n",(0,s.jsx)(n.li,{children:"Implement sophisticated batching strategies"}),"\n",(0,s.jsx)(n.li,{children:"Monitor batcher operations in production"}),"\n",(0,s.jsx)(n.li,{children:"Build custom storage backends"}),"\n",(0,s.jsx)(n.li,{children:"Add logging, metrics, or alerting integrations"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"http-api",children:"HTTP API"}),"\n",(0,s.jsxs)(n.p,{children:["The Batcher exposes a RESTful HTTP API when ",(0,s.jsx)(n.code,{children:"enableHttpServer"})," is enabled. The API includes comprehensive OpenAPI documentation accessible at ",(0,s.jsx)(n.code,{children:"/documentation"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(n.p,{children:"Enable the HTTP server in your configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const config: PaimaBatcherConfig = {\n  enableHttpServer: true,\n  port: 3334,\n  // ... other config\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The API will be available at ",(0,s.jsx)(n.code,{children:"http://localhost:3334"})," with interactive documentation at ",(0,s.jsx)(n.code,{children:"http://localhost:3334/documentation"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"endpoints",children:"Endpoints"}),"\n",(0,s.jsxs)(n.h4,{id:"1-post-send-input--submit-user-input",children:["1. ",(0,s.jsx)(n.code,{children:"POST /send-input"})," \u2013 Submit User Input"]}),"\n",(0,s.jsx)(n.p,{children:"Submit a new input to the batching queue."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Request Body:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  "data": {\n    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",\n    "addressType": 0,  // AddressType.EVM\n    "input": "myGameCommand|arg1|arg2",\n    "signature": "0x...",\n    "timestamp": "1234567890",\n    "target": "ethereum"  // Optional, uses defaultTarget if not specified\n  },\n  "confirmationLevel": "wait-receipt"  // Optional: "no-wait" | "wait-receipt" | "wait-effectstream-processed"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Confirmation Level Behavior:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Level"}),(0,s.jsx)(n.th,{children:"Returns When"}),(0,s.jsx)(n.th,{children:"Response Includes"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"no-wait"'})}),(0,s.jsx)(n.td,{children:"Immediately after queuing"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{ success, message, inputsProcessed }"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"wait-receipt"'})}),(0,s.jsx)(n.td,{children:"After blockchain confirmation"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{ success, message, transactionHash, inputsProcessed }"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"wait-effectstream-processed"'})}),(0,s.jsx)(n.td,{children:"After Paima Engine processes"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"{ success, message, transactionHash, rollup, inputsProcessed }"})})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.strong,{children:["Response Example (",(0,s.jsx)(n.code,{children:"wait-receipt"}),"):"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "success": true,\n  "message": "Input processed successfully",\n  "transactionHash": "0xabc123...",\n  "inputsProcessed": 1\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Error Responses:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Status Code"}),(0,s.jsx)(n.th,{children:"Meaning"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"400 Bad Request"})}),(0,s.jsx)(n.td,{children:"Invalid input format or validation failure"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"401 Unauthorized"})}),(0,s.jsx)(n.td,{children:"Signature verification failed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"404 Not Found"})}),(0,s.jsx)(n.td,{children:"Specified target adapter doesn't exist"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"503 Service Unavailable"})}),(0,s.jsx)(n.td,{children:"Batcher is shutting down"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:3334/send-input \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "data": {\n      "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",\n      "addressType": 0,\n      "input": "move|x10y20",\n      "signature": "0x...",\n      "timestamp": "1234567890"\n    },\n    "confirmationLevel": "wait-receipt"\n  }\'\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"2-get-status--batcher-status",children:["2. ",(0,s.jsx)(n.code,{children:"GET /status"})," \u2013 Batcher Status"]}),"\n",(0,s.jsx)(n.p,{children:"Get comprehensive batcher status including configuration and queue statistics."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Response:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  "batcher": {\n    "isInitialized": true,\n    "totalPendingInputs": 42,\n    "targets": [\n      {\n        "target": "ethereum",\n        "pendingInputs": 30,\n        "isReady": false,\n        "criteriaType": "time",\n        "timeSinceLastProcess": 3500\n      },\n      {\n        "target": "midnight",\n        "pendingInputs": 12,\n        "isReady": true,\n        "criteriaType": "size",\n        "timeSinceLastProcess": 8000\n      }\n    ],\n    "adapterTargets": ["ethereum", "midnight"]\n  },\n  "config": {\n    "pollingIntervalMs": 1000,\n    "defaultTarget": "ethereum",\n    "enableHttpServer": true,\n    "enableEventSystem": true,\n    "confirmationLevel": "wait-receipt"\n  },\n  "timestamp": "2025-01-15T12:34:56.789Z"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Health checks for load balancers"}),"\n",(0,s.jsx)(n.li,{children:"Monitoring dashboards"}),"\n",(0,s.jsx)(n.li,{children:"Debugging queue state"}),"\n",(0,s.jsx)(n.li,{children:"Verifying configuration"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl http://localhost:3334/status\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"3-get-queue-stats--queue-statistics",children:["3. ",(0,s.jsx)(n.code,{children:"GET /queue-stats"})," \u2013 Queue Statistics"]}),"\n",(0,s.jsxs)(n.p,{children:["Get detailed per-target queue statistics (lightweight version of ",(0,s.jsx)(n.code,{children:"/status"}),")."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Response:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  "totalPendingInputs": 42,\n  "targets": [\n    {\n      "target": "ethereum",\n      "pendingInputs": 30,\n      "isReady": false,\n      "criteriaType": "time",\n      "timeSinceLastProcess": 3500\n    },\n    {\n      "target": "midnight",\n      "pendingInputs": 12,\n      "isReady": true,\n      "criteriaType": "size",\n      "timeSinceLastProcess": 8000\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl http://localhost:3334/queue-stats\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"4-post-force-batch--force-batch-processing-developer",children:["4. ",(0,s.jsx)(n.code,{children:"POST /force-batch"})," \u2013 Force Batch Processing (Developer)"]}),"\n",(0,s.jsx)(n.p,{children:"Immediately trigger batch processing for all targets, bypassing batching criteria."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Testing and debugging"}),"\n",(0,s.jsx)(n.li,{children:"Manual batch submission during off-peak hours"}),"\n",(0,s.jsx)(n.li,{children:"Emergency queue draining"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Response:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "success": true,\n  "message": "Batch processing forced",\n  "remainingInputs": 5\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Warning:"})," This endpoint is intended for ",(0,s.jsx)(n.strong,{children:"development and operational use only"}),". In production, batching criteria should determine when batches are submitted."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl -X POST http://localhost:3334/force-batch\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"5-get-health--health-check",children:["5. ",(0,s.jsx)(n.code,{children:"GET /health"})," \u2013 Health Check"]}),"\n",(0,s.jsx)(n.p,{children:"Lightweight health check endpoint for monitoring systems."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Response:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "status": "ok",\n  "isInitialized": true,\n  "isRunning": true\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl http://localhost:3334/health\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"6-delete-clear-inputs--clear-pending-inputs-developer",children:["6. ",(0,s.jsx)(n.code,{children:"DELETE /clear-inputs"})," \u2013 Clear Pending Inputs (Developer)"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u26a0\ufe0f DESTRUCTIVE OPERATION"})," \u2013 Delete all pending inputs from storage."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Testing environment cleanup"}),"\n",(0,s.jsx)(n.li,{children:"Recovery from corrupted queue state"}),"\n",(0,s.jsx)(n.li,{children:"Development workflow reset"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Response:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "success": true,\n  "message": "All pending inputs cleared"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Warning:"})," This operation is ",(0,s.jsx)(n.strong,{children:"irreversible"}),". Use with extreme caution, especially in production environments."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl -X DELETE http://localhost:3334/clear-inputs\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"openapi-documentation",children:"OpenAPI Documentation"}),"\n",(0,s.jsx)(n.p,{children:"The batcher includes interactive API documentation powered by Swagger UI."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Access:"})," ",(0,s.jsx)(n.code,{children:"http://localhost:3334/documentation"})]}),"\n",(0,s.jsx)(n.p,{children:"Features:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Try It Out"}),": Test API endpoints directly from the browser"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Schema Validation"}),": View request/response schemas"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Example Values"}),": Pre-filled example payloads"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Export"}),": Download OpenAPI spec as JSON or YAML"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Programmatic Access:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["JSON spec: ",(0,s.jsx)(n.code,{children:"http://localhost:3334/documentation/json"})]}),"\n",(0,s.jsxs)(n.li,{children:["YAML spec: ",(0,s.jsx)(n.code,{children:"http://localhost:3334/documentation/yaml"})]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"batching-criteria",children:"Batching Criteria"}),"\n",(0,s.jsxs)(n.p,{children:["Batching criteria define ",(0,s.jsx)(n.strong,{children:"when"})," the batcher should submit accumulated inputs to the blockchain. Each adapter target can have its own independent criteria."]}),"\n",(0,s.jsx)(n.h3,{id:"configuration-structure",children:"Configuration Structure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'const config: PaimaBatcherConfig = {\n  batchingCriteria: {\n    [targetName]: {\n      criteriaType: "time" | "size" | "value" | "hybrid" | "custom",\n      // ... type-specific fields\n    }\n  }\n};\n'})}),"\n",(0,s.jsx)(n.p,{children:"If no criteria is specified for a target, it defaults to:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{ criteriaType: "size", maxBatchSize: 1 }  // Process immediately\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"criteria-types",children:"Criteria Types"}),"\n",(0,s.jsx)(n.h4,{id:"1-time-based-criteria",children:"1. Time-Based Criteria"}),"\n",(0,s.jsx)(n.p,{children:"Submit batches at regular time intervals, regardless of input count."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  criteriaType: "time",\n  timeWindowMs: 5000  // Submit every 5 seconds\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Predictable submission schedules"}),": Submit every 5 minutes for cost efficiency"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Low-frequency applications"}),": Games with turn-based mechanics"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Cost optimization"}),": Batch during off-peak hours to reduce gas fees"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Timer resets after each batch submission"}),"\n",(0,s.jsx)(n.li,{children:"If queue is empty when timer expires, nothing happens"}),"\n",(0,s.jsx)(n.li,{children:"Multiple inputs submitted in same batch reduce per-input costs"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addBlockchainAdapter("ethereum", evmAdapter, {\n  criteriaType: "time",\n  timeWindowMs: 300000  // Submit every 5 minutes\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"2-size-based-criteria",children:"2. Size-Based Criteria"}),"\n",(0,s.jsx)(n.p,{children:"Submit batches when the input queue reaches a certain length."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  criteriaType: "size",\n  maxBatchSize: 100  // Submit when 100 inputs accumulate\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Important:"})," The ",(0,s.jsx)(n.code,{children:"maxBatchSize"})," here represents ",(0,s.jsx)(n.strong,{children:"number of inputs"}),", not bytes. This is different from the adapter's ",(0,s.jsx)(n.code,{children:"maxBatchSize"})," (which limits serialized batch size in bytes)."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"High-throughput applications"}),": Process as soon as enough inputs accumulate"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Fairness guarantees"}),": Ensure inputs are processed within N other inputs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Burst handling"}),": Automatically batch during traffic spikes"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Checked on every polling interval (",(0,s.jsx)(n.code,{children:"pollingIntervalMs"}),")"]}),"\n",(0,s.jsx)(n.li,{children:"If 100+ inputs are queued, batch is submitted immediately"}),"\n",(0,s.jsx)(n.li,{children:"Remaining inputs stay queued for next batch"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addBlockchainAdapter("nft", nftAdapter, {\n  criteriaType: "size",\n  maxBatchSize: 50  // Submit when 50 mint requests accumulate\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"3-value-based-criteria",children:"3. Value-Based Criteria"}),"\n",(0,s.jsx)(n.p,{children:'Submit batches when the accumulated "value" of inputs reaches a threshold. Useful for financial applications where you want to batch by transaction volume.'}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  criteriaType: "value",\n  valueAccumulatorFn: (input: MyInput) => input.amount,  // Extract value\n  targetValue: 1000  // Submit when total reaches 1000\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Payment batching"}),": Submit when total value reaches $1000"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Token transfers"}),": Batch until X tokens accumulated"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Priority systems"}),': Accumulate "priority points" until threshold']}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"valueAccumulatorFn"})," extracts numeric value from each input"]}),"\n",(0,s.jsx)(n.li,{children:"Values are summed across all pending inputs"}),"\n",(0,s.jsxs)(n.li,{children:["Batch submitted when sum \u2265 ",(0,s.jsx)(n.code,{children:"targetValue"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'interface PaymentInput extends DefaultBatcherInput {\n  amount: number;  // Custom field\n}\n\nbatcher.addBlockchainAdapter("payments", paymentsAdapter, {\n  criteriaType: "value",\n  valueAccumulatorFn: (input: PaymentInput) => input.amount,\n  targetValue: 100000  // Submit when $1000 accumulated (cents)\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"4-hybrid-criteria",children:"4. Hybrid Criteria"}),"\n",(0,s.jsxs)(n.p,{children:["Submit batches when ",(0,s.jsx)(n.strong,{children:"either"})," time or size criteria is met (whichever comes first)."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  criteriaType: "hybrid",\n  timeWindowMs: 60000,   // 1 minute timeout\n  maxBatchSize: 100       // OR 100 inputs\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Responsive with backpressure protection"}),": Don't wait forever for size, but don't submit tiny batches"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Variable traffic"}),": Handle both high and low traffic gracefully"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Latency guarantees"}),': "Process within 1 minute OR 100 inputs"']}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Whichever condition is met first triggers batch submission"}),"\n",(0,s.jsx)(n.li,{children:"Both timers and counters reset after submission"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addBlockchainAdapter("polygon", polygonAdapter, {\n  criteriaType: "hybrid",\n  timeWindowMs: 5000,    // At most 5 seconds between batches\n  maxBatchSize: 50        // At most 50 inputs queued\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"5-custom-criteria",children:"5. Custom Criteria"}),"\n",(0,s.jsx)(n.p,{children:"Define completely custom logic for determining batch readiness using a function."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  criteriaType: "custom",\n  isBatchReadyFn: async (inputs, lastProcessTime) => {\n    // Your custom logic\n    return true; // or false\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Function Signature:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"type BatchReadyFunction<T> = (\n  pendingInputs: T[],\n  lastProcessTime: number  // Timestamp of last batch submission\n) => boolean | Promise<boolean>\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Complex business logic"}),": Multi-factor batching decisions"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"External signals"}),": Check external API for batch timing"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Priority systems"}),": Process immediately if high-priority input exists"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Gas price monitoring"}),": Submit when gas prices drop below threshold"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example 1: Priority-Based Batching"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'interface PriorityInput extends DefaultBatcherInput {\n  priority: "low" | "medium" | "high";\n}\n\nbatcher.addBlockchainAdapter("priority", priorityAdapter, {\n  criteriaType: "custom",\n  isBatchReadyFn: (inputs: PriorityInput[], lastProcessTime) => {\n    // Submit immediately if any high-priority input exists\n    const hasHighPriority = inputs.some(inp => inp.priority === "high");\n    if (hasHighPriority) return true;\n    \n    // Otherwise, wait for 10 seconds or 20 inputs\n    const timePassed = Date.now() - lastProcessTime > 10000;\n    const enoughInputs = inputs.length >= 20;\n    return timePassed || enoughInputs;\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example 2: Gas Price Monitoring"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addBlockchainAdapter("ethereum", evmAdapter, {\n  criteriaType: "custom",\n  isBatchReadyFn: async (inputs, lastProcessTime) => {\n    // Don\'t submit if queue is empty\n    if (inputs.length === 0) return false;\n    \n    // Fetch current gas price\n    const gasPrice = await publicClient.getGasPrice();\n    const gasPriceGwei = Number(gasPrice) / 1e9;\n    \n    // Submit if gas is cheap (< 20 gwei) OR we\'ve waited > 5 minutes\n    const gasIsCheap = gasPriceGwei < 20;\n    const timeoutReached = Date.now() - lastProcessTime > 300000;\n    \n    return gasIsCheap || timeoutReached;\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example 3: External API Signal"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addBlockchainAdapter("midnight", midnightAdapter, {\n  criteriaType: "custom",\n  isBatchReadyFn: async (inputs) => {\n    if (inputs.length === 0) return false;\n    \n    // Check if backend approves batch submission\n    const response = await fetch("https://api.example.com/should-batch");\n    const { shouldBatch } = await response.json();\n    \n    return shouldBatch && inputs.length >= 5;\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Error Handling:"})}),"\n",(0,s.jsxs)(n.p,{children:["If ",(0,s.jsx)(n.code,{children:"isBatchReadyFn"})," throws an error:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Error is logged to console"}),"\n",(0,s.jsxs)(n.li,{children:["Function returns ",(0,s.jsx)(n.code,{children:"false"})," (batch not ready)"]}),"\n",(0,s.jsx)(n.li,{children:"Batcher continues polling normally"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Always wrap external calls in try/catch if they might fail:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'isBatchReadyFn: async (inputs) => {\n  try {\n    const result = await externalApi.checkCondition();\n    return result.ready;\n  } catch (error) {\n    console.error("Custom criteria failed:", error);\n    return false;  // Fail safe\n  }\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"batching-criteria-best-practices",children:"Batching Criteria Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Start with hybrid criteria"})," for most applications:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{ criteriaType: "hybrid", timeWindowMs: 5000, maxBatchSize: 50 }\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Consider gas costs"}),": Larger batches = lower per-input cost, but watch adapter ",(0,s.jsx)(n.code,{children:"maxBatchSize"})," limits"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Monitor queue depth"}),": Use ",(0,s.jsx)(n.code,{children:"/queue-stats"})," to ensure criteria aren't too conservative"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Test under load"}),": Simulate traffic patterns to validate criteria performance"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Per-chain optimization"}),": Different chains have different cost profiles\u2014configure accordingly"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"event-system",children:"Event System"}),"\n",(0,s.jsxs)(n.p,{children:["The event system provides ",(0,s.jsx)(n.strong,{children:"lifecycle hooks"})," for observability, logging, metrics, and custom behavior. Events are emitted at key points in the batching pipeline."]}),"\n",(0,s.jsx)(n.h3,{id:"enabling-events",children:"Enabling Events"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const config: PaimaBatcherConfig = {\n  enableEventSystem: true,  // Required to emit events\n  // ... other config\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," Even with ",(0,s.jsx)(n.code,{children:"enableEventSystem: false"}),", you can still register listeners\u2014they just won't be called."]}),"\n",(0,s.jsx)(n.h3,{id:"adding-event-listeners",children:"Adding Event Listeners"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"batcher.addStateTransition()"})," to register listeners:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("startup", (payload) => {\n  console.log("Batcher started:", payload.publicConfig);\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Listener Signature:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"type BatcherListener<Prefix> = (\n  payload: Grammar[Prefix]\n) => void | Promise<void>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Listeners can be ",(0,s.jsx)(n.strong,{children:"synchronous or asynchronous"}),". The event system handles both automatically using Effection's ",(0,s.jsx)(n.code,{children:"lift()"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"available-events",children:"Available Events"}),"\n",(0,s.jsx)(n.p,{children:"The batcher emits the following events:"}),"\n",(0,s.jsxs)(n.h4,{id:"1-startup--batcher-initialization",children:["1. ",(0,s.jsx)(n.code,{children:"startup"})," \u2013 Batcher Initialization"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," After the batcher is initialized and ready to accept inputs."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{\n  publicConfig: {\n    pollingIntervalMs: number;\n    defaultTarget: string;\n    enableHttpServer: boolean;\n    enableEventSystem: boolean;\n    confirmationLevel: string | Record<string, string>;\n    port: number;\n    adapterTargets: string[];\n    criteriaTypes: Record<string, string>;\n  };\n  time: number;  // Timestamp\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("startup", ({ publicConfig }) => {\n  console.log(`\ud83d\ude80 Batcher started on port ${publicConfig.port}`);\n  console.log(`   Default target: ${publicConfig.defaultTarget}`);\n  console.log(`   Adapters: ${publicConfig.adapterTargets.join(", ")}`);\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"2-httpstart--http-server-started",children:["2. ",(0,s.jsx)(n.code,{children:"http:start"})," \u2013 HTTP Server Started"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," HTTP server successfully starts."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{ port: number; time: number }\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("http:start", ({ port }) => {\n  console.log(`\ud83c\udf10 HTTP API: http://localhost:${port}`);\n  console.log(`\ud83d\udcd6 Docs: http://localhost:${port}/documentation`);\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"3-httpstop--http-server-stopped",children:["3. ",(0,s.jsx)(n.code,{children:"http:stop"})," \u2013 HTTP Server Stopped"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," HTTP server is stopped (usually during shutdown)."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{ time: number }\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"4-polltargets-ready--targets-ready-for-batching",children:["4. ",(0,s.jsx)(n.code,{children:"poll:targets-ready"})," \u2013 Targets Ready for Batching"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Polling detects one or more targets have met their batching criteria."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{ targets: string[]; time: number }\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("poll:targets-ready", ({ targets }) => {\n  console.log(`\ud83d\udce6 Ready to batch: ${targets.join(", ")}`);\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"5-batchprocessstart--batch-processing-started",children:["5. ",(0,s.jsx)(n.code,{children:"batch:process:start"})," \u2013 Batch Processing Started"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," A batch processing operation begins for a specific target."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{ target: string; inputCount: number; time: number }\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("batch:process:start", ({ target, inputCount }) => {\n  console.log(`\u2699\ufe0f Processing ${inputCount} inputs for ${target}`);\n  metrics.increment("batcher.batch.start", { target });\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"6-batchfee-estimate--fee-estimated",children:["6. ",(0,s.jsx)(n.code,{children:"batch:fee-estimate"})," \u2013 Fee Estimated"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Transaction fee has been estimated before submission."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{ target: string; estimatedFee: bigint; time: number }\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("batch:fee-estimate", ({ target, estimatedFee }) => {\n  const feeEth = Number(estimatedFee) / 1e18;\n  console.log(`\ud83d\udcb0 Estimated fee for ${target}: ${feeEth.toFixed(6)} ETH`);\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"7-batchsubmit--batch-submitted-to-blockchain",children:["7. ",(0,s.jsx)(n.code,{children:"batch:submit"})," \u2013 Batch Submitted to Blockchain"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Transaction has been submitted to the blockchain."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{\n  target: string;\n  estimatedFee: bigint;\n  txHash: string;\n  time: number;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("batch:submit", ({ target, txHash }) => {\n  console.log(`\ud83d\ude80 Submitted to ${target}: ${txHash}`);\n  database.recordSubmission(target, txHash);\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"8-batchreceipt--transaction-confirmed",children:["8. ",(0,s.jsx)(n.code,{children:"batch:receipt"})," \u2013 Transaction Confirmed"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Blockchain confirms the transaction (receipt received)."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{\n  target: string;\n  blockNumber: number | bigint;\n  time: number;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("batch:receipt", ({ target, blockNumber }) => {\n  console.log(`\u2705 Confirmed on ${target} in block ${blockNumber}`);\n  metrics.increment("batcher.batch.confirmed", { target });\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"9-batcheffectstream-processed--paima-engine-processed",children:["9. ",(0,s.jsx)(n.code,{children:"batch:effectstream-processed"})," \u2013 Paima Engine Processed"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Paima Engine has processed the batch (only if waiting for ",(0,s.jsx)(n.code,{children:"wait-effectstream-processed"}),")."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{\n  target: string;\n  latestBlock: number;\n  rollup: number;\n  time: number;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("batch:effectstream-processed", ({ target, rollup }) => {\n  console.log(`\ud83c\udfaf Paima processed ${target} batch in rollup block ${rollup}`);\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"10-batchprocessend--batch-processing-complete",children:["10. ",(0,s.jsx)(n.code,{children:"batch:process:end"})," \u2013 Batch Processing Complete"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," Batch processing finishes (successfully or with errors)."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{\n  target: string;\n  processedCount: number;\n  success: boolean;\n  time: number;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("batch:process:end", ({ target, processedCount, success }) => {\n  if (success) {\n    console.log(`\u2705 Processed ${processedCount} inputs for ${target}`);\n  } else {\n    console.error(`\u274c Batch failed for ${target}`);\n  }\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h4,{id:"11-error--error-occurred",children:["11. ",(0,s.jsx)(n.code,{children:"error"})," \u2013 Error Occurred"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When:"})," An error occurs during any phase of batching."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Payload:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'{\n  phase: string;      // e.g., "batch", "event-listener:startup"\n  target?: string;    // Target name if error is target-specific\n  error: unknown;     // The error object\n  time: number;\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("error", ({ phase, target, error }) => {\n  console.error(`\u274c Error in ${phase}${target ? ` (${target})` : ""}:`, error);\n  errorReporter.report({\n    phase,\n    target,\n    error,\n    timestamp: new Date().toISOString()\n  });\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"event-system-best-practices",children:"Event System Best Practices"}),"\n",(0,s.jsx)(n.h4,{id:"1-use-for-observability",children:"1. Use for Observability"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// Logging\nbatcher.addStateTransition("batch:submit", ({ target, txHash }) => {\n  logger.info("Batch submitted", { target, txHash });\n});\n\n// Metrics\nbatcher.addStateTransition("batch:receipt", ({ target }) => {\n  metrics.increment("batches.confirmed", { target });\n});\n\n// Tracing\nbatcher.addStateTransition("batch:process:start", ({ target, inputCount }) => {\n  tracer.startSpan("batch.process", { target, inputCount });\n});\n'})}),"\n",(0,s.jsx)(n.h4,{id:"2-error-handling-in-listeners",children:"2. Error Handling in Listeners"}),"\n",(0,s.jsxs)(n.p,{children:["Event listeners should ",(0,s.jsx)(n.strong,{children:"not throw errors"}),"\u2014they run in background fibers and failures don't affect the main batcher:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("batch:submit", async ({ txHash }) => {\n  try {\n    await database.recordTransaction(txHash);\n  } catch (error) {\n    console.error("Failed to record transaction:", error);\n    // Don\'t throw\u2014just log and continue\n  }\n});\n'})}),"\n",(0,s.jsxs)(n.p,{children:["If a listener throws, the error is caught and emitted as an ",(0,s.jsx)(n.code,{children:'"error"'})," event with ",(0,s.jsx)(n.code,{children:'phase: "event-listener:<prefix>"'}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"3-prevent-duplicate-listeners",children:"3. Prevent Duplicate Listeners"}),"\n",(0,s.jsxs)(n.p,{children:["The batcher ",(0,s.jsx)(n.strong,{children:"throws an error"})," if you register the same prefix twice:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.addStateTransition("startup", () => console.log("First"));\nbatcher.addStateTransition("startup", () => console.log("Second"));\n// \u274c Error: "Disallowed: duplicate listener for prefix startup"\n'})}),"\n",(0,s.jsx)(n.p,{children:"This prevents determinism issues. Use different prefixes or remove the old listener:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'batcher.removeStateTransition("startup");\nbatcher.addStateTransition("startup", () => console.log("Replaced"));\n'})}),"\n",(0,s.jsx)(n.h4,{id:"4-complete-monitoring-example",children:"4. Complete Monitoring Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// Startup\nbatcher.addStateTransition("startup", ({ publicConfig }) => {\n  console.log(`\ud83d\ude80 Batcher started`);\n  console.log(`   Adapters: ${publicConfig.adapterTargets.join(", ")}`);\n  metrics.gauge("batcher.adapters", publicConfig.adapterTargets.length);\n});\n\n// Batch lifecycle\nbatcher.addStateTransition("batch:process:start", ({ target, inputCount }) => {\n  console.log(`\u2699\ufe0f ${target}: Processing ${inputCount} inputs`);\n  metrics.histogram("batcher.batch.size", inputCount, { target });\n});\n\nbatcher.addStateTransition("batch:submit", ({ target, txHash, estimatedFee }) => {\n  console.log(`\ud83d\ude80 ${target}: Submitted ${txHash}`);\n  metrics.increment("batcher.txs.submitted", { target });\n  metrics.histogram("batcher.fee", Number(estimatedFee), { target });\n});\n\nbatcher.addStateTransition("batch:receipt", ({ target, blockNumber }) => {\n  console.log(`\u2705 ${target}: Confirmed in block ${blockNumber}`);\n  metrics.increment("batcher.txs.confirmed", { target });\n});\n\n// Errors\nbatcher.addStateTransition("error", ({ phase, target, error }) => {\n  console.error(`\u274c Error in ${phase}${target ? ` (${target})` : ""}:`, error);\n  errorTracker.captureException(error, { phase, target });\n  metrics.increment("batcher.errors", { phase, target: target || "global" });\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"storage-system",children:"Storage System"}),"\n",(0,s.jsxs)(n.p,{children:["Storage is the ",(0,s.jsx)(n.strong,{children:"single source of truth"})," for all pending inputs. There are no in-memory queues\u2014everything is persisted immediately, making the batcher crash-safe."]}),"\n",(0,s.jsxs)(n.h3,{id:"the-batcherstorage-interface",children:["The ",(0,s.jsx)(n.code,{children:"BatcherStorage"})," Interface"]}),"\n",(0,s.jsx)(n.p,{children:"All storage backends implement this interface:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface BatcherStorage<T extends DefaultBatcherInput = DefaultBatcherInput> {\n  /**\n   * Initialize the storage (create directories, tables, etc.)\n   */\n  init(): Promise<void>;\n\n  /**\n   * Add a new input to storage\n   */\n  addInput(input: T): Promise<void>;\n\n  /**\n   * Get all pending inputs\n   */\n  getAllInputs(): Promise<T[]>;\n\n  /**\n   * Remove specific processed inputs from storage\n   */\n  removeProcessedInputs(processedInputs: T[]): Promise<void>;\n\n  /**\n   * Get the count and total size of pending inputs\n   */\n  getInputCountAndSize(): Promise<{ count: number; size: number }>;\n\n  /**\n   * Get all pending inputs for a specific target\n   */\n  getInputsByTarget(target: string, defaultTarget: string): Promise<T[]>;\n\n  /**\n   * Clear all inputs (useful for testing)\n   */\n  clearAllInputs(): Promise<void>;\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"built-in-filestorage",children:["Built-in: ",(0,s.jsx)(n.code,{children:"FileStorage"})]}),"\n",(0,s.jsx)(n.p,{children:"The default storage backend uses JSONL (JSON Lines) files for simplicity and human readability."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Usage:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { FileStorage } from "@effectstream/batcher";\n\nconst storage = new FileStorage("./batcher-data");\nconst batcher = createNewBatcher(config, storage);\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"File Structure:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"./batcher-data/\n  pending-inputs.jsonl  # One JSON object per line\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.strong,{children:["Example ",(0,s.jsx)(n.code,{children:"pending-inputs.jsonl"}),":"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsonl",children:'{"address":"0x742d35Cc...","addressType":0,"input":"move|x10y20","signature":"0x...","timestamp":"1234567890"}\n{"address":"0xabc123...","addressType":0,"input":"attack|id5","signature":"0x...","timestamp":"1234567891"}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Features:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Simple"}),": No database setup required"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Human-readable"}),": Easy to inspect and debug"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Crash-safe"}),": Uses atomic file operations"]}),"\n",(0,s.jsxs)(n.li,{children:["\u26a0\ufe0f ",(0,s.jsx)(n.strong,{children:"Not for production"}),": Poor performance at scale"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Limitations:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Not scalable"}),": Full file read/write on every operation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"No transactions"}),": Can't guarantee atomicity across multiple operations"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"No indexing"}),": ",(0,s.jsx)(n.code,{children:"getInputsByTarget()"})," scans entire file"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Single machine"}),": Can't be shared across multiple batcher instances"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"custom-storage-implementations",children:"Custom Storage Implementations"}),"\n",(0,s.jsxs)(n.p,{children:["Implement ",(0,s.jsx)(n.code,{children:"BatcherStorage"})," to use any backend:"]}),"\n",(0,s.jsx)(n.h4,{id:"example-postgresql-storage",children:"Example: PostgreSQL Storage"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { Pool } from "pg";\nimport type { BatcherStorage, DefaultBatcherInput } from "@effectstream/batcher";\n\nexport class PostgreSQLStorage<T extends DefaultBatcherInput>\n  implements BatcherStorage<T> {\n  \n  private pool: Pool;\n\n  constructor(connectionString: string) {\n    this.pool = new Pool({ connectionString });\n  }\n\n  async init(): Promise<void> {\n    await this.pool.query(`\n      CREATE TABLE IF NOT EXISTS batcher_inputs (\n        id SERIAL PRIMARY KEY,\n        address TEXT NOT NULL,\n        address_type INTEGER NOT NULL,\n        input TEXT NOT NULL,\n        signature TEXT,\n        timestamp TEXT NOT NULL,\n        target TEXT,\n        created_at TIMESTAMP DEFAULT NOW()\n      );\n      CREATE INDEX IF NOT EXISTS idx_target ON batcher_inputs(target);\n    `);\n  }\n\n  async addInput(input: T): Promise<void> {\n    await this.pool.query(\n      `INSERT INTO batcher_inputs (address, address_type, input, signature, timestamp, target)\n       VALUES ($1, $2, $3, $4, $5, $6)`,\n      [\n        input.address,\n        input.addressType,\n        input.input,\n        input.signature,\n        input.timestamp,\n        input.target || null\n      ]\n    );\n  }\n\n  async getAllInputs(): Promise<T[]> {\n    const result = await this.pool.query(\n      `SELECT * FROM batcher_inputs ORDER BY created_at ASC`\n    );\n    return result.rows.map(row => ({\n      address: row.address,\n      addressType: row.address_type,\n      input: row.input,\n      signature: row.signature,\n      timestamp: row.timestamp,\n      target: row.target\n    })) as T[];\n  }\n\n  async removeProcessedInputs(processedInputs: T[]): Promise<void> {\n    if (processedInputs.length === 0) return;\n    \n    // Use signature + timestamp as unique identifier\n    const signatures = processedInputs.map(inp => inp.signature);\n    await this.pool.query(\n      `DELETE FROM batcher_inputs WHERE signature = ANY($1)`,\n      [signatures]\n    );\n  }\n\n  async getInputCountAndSize(): Promise<{ count: number; size: number }> {\n    const result = await this.pool.query(\n      `SELECT COUNT(*) as count, \n              COALESCE(SUM(LENGTH(input)), 0) as size \n       FROM batcher_inputs`\n    );\n    return {\n      count: parseInt(result.rows[0].count),\n      size: parseInt(result.rows[0].size)\n    };\n  }\n\n  async getInputsByTarget(target: string, defaultTarget: string): Promise<T[]> {\n    const result = await this.pool.query(\n      `SELECT * FROM batcher_inputs \n       WHERE target = $1 OR (target IS NULL AND $2 = $1)\n       ORDER BY created_at ASC`,\n      [target, defaultTarget]\n    );\n    return result.rows.map(row => ({\n      address: row.address,\n      addressType: row.address_type,\n      input: row.input,\n      signature: row.signature,\n      timestamp: row.timestamp,\n      target: row.target\n    })) as T[];\n  }\n\n  async clearAllInputs(): Promise<void> {\n    await this.pool.query(`TRUNCATE TABLE batcher_inputs`);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Usage:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'const storage = new PostgreSQLStorage("postgresql://user:pass@localhost/batcher");\nconst batcher = createNewBatcher(config, storage);\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"example-redis-storage",children:"Example: Redis Storage"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import Redis from "ioredis";\nimport type { BatcherStorage, DefaultBatcherInput } from "@effectstream/batcher";\n\nexport class RedisStorage<T extends DefaultBatcherInput>\n  implements BatcherStorage<T> {\n  \n  private redis: Redis;\n  private readonly queueKey = "batcher:pending-inputs";\n\n  constructor(redisUrl: string) {\n    this.redis = new Redis(redisUrl);\n  }\n\n  async init(): Promise<void> {\n    // Redis doesn\'t require initialization\n    await this.redis.ping();\n  }\n\n  async addInput(input: T): Promise<void> {\n    await this.redis.rpush(this.queueKey, JSON.stringify(input));\n  }\n\n  async getAllInputs(): Promise<T[]> {\n    const inputs = await this.redis.lrange(this.queueKey, 0, -1);\n    return inputs.map(str => JSON.parse(str));\n  }\n\n  async removeProcessedInputs(processedInputs: T[]): Promise<void> {\n    if (processedInputs.length === 0) return;\n    \n    // Remove by value (inefficient for large lists\u2014consider using sorted sets instead)\n    const pipeline = this.redis.pipeline();\n    for (const input of processedInputs) {\n      pipeline.lrem(this.queueKey, 1, JSON.stringify(input));\n    }\n    await pipeline.exec();\n  }\n\n  async getInputCountAndSize(): Promise<{ count: number; size: number }> {\n    const count = await this.redis.llen(this.queueKey);\n    const inputs = await this.redis.lrange(this.queueKey, 0, -1);\n    const size = inputs.reduce((sum, str) => sum + str.length, 0);\n    return { count, size };\n  }\n\n  async getInputsByTarget(target: string, defaultTarget: string): Promise<T[]> {\n    const allInputs = await this.getAllInputs();\n    return allInputs.filter(input => \n      input.target === target || (!input.target && defaultTarget === target)\n    );\n  }\n\n  async clearAllInputs(): Promise<void> {\n    await this.redis.del(this.queueKey);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"storage-best-practices",children:"Storage Best Practices"}),"\n",(0,s.jsx)(n.h4,{id:"1-choose-based-on-scale",children:"1. Choose Based on Scale"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Scale"}),(0,s.jsx)(n.th,{children:"Recommended Storage"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Development"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FileStorage"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Small production (< 1000 inputs/sec)"}),(0,s.jsx)(n.td,{children:"PostgreSQL with connection pooling"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"High throughput (> 1000 inputs/sec)"}),(0,s.jsx)(n.td,{children:"Redis with persistence enabled"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Distributed batcher"}),(0,s.jsx)(n.td,{children:"PostgreSQL or Redis Cluster"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"2-ensure-atomicity",children:"2. Ensure Atomicity"}),"\n",(0,s.jsxs)(n.p,{children:["Storage operations should be ",(0,s.jsx)(n.strong,{children:"atomic"})," to prevent race conditions:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// \u274c Bad: Non-atomic read-modify-write\nconst inputs = await storage.getAllInputs();\nconst filtered = inputs.filter(/* ... */);\nawait storage.removeProcessedInputs(filtered);\n\n// \u2705 Good: Use removeProcessedInputs with exact inputs\nawait storage.removeProcessedInputs(processedInputs);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"3-handle-crashes-gracefully",children:"3. Handle Crashes Gracefully"}),"\n",(0,s.jsx)(n.p,{children:"The batcher reloads all pending inputs from storage on restart:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// After crash/restart:\nawait batcher.init();  // Reloads pending-inputs.jsonl\n// All unprocessed inputs are still in the queue\n"})}),"\n",(0,s.jsx)(n.h4,{id:"4-monitor-storage-health",children:"4. Monitor Storage Health"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// Periodically check queue depth\nsetInterval(async () => {\n  const { count, size } = await storage.getInputCountAndSize();\n  console.log(`Queue: ${count} inputs (${size} bytes)`);\n  metrics.gauge("batcher.queue.size", count);\n}, 60000);\n'})}),"\n",(0,s.jsx)(n.h4,{id:"5-implement-backuprestore",children:"5. Implement Backup/Restore"}),"\n",(0,s.jsx)(n.p,{children:"For production storage, implement backup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// PostgreSQL: pg_dump\npg_dump -t batcher_inputs batcher_db > backup.sql\n\n// Redis: SAVE or BGSAVE\nredis-cli BGSAVE\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"effection-integration",children:"Effection Integration"}),"\n",(0,s.jsxs)(n.p,{children:["The Batcher uses ",(0,s.jsx)(n.strong,{children:"Effection"})," for structured concurrency, providing automatic resource cleanup, graceful cancellation, and robust error handling. This section explains how to run the batcher using Effection's ",(0,s.jsx)(n.code,{children:"main()"})," function."]}),"\n",(0,s.jsx)(n.h3,{id:"what-is-effection",children:"What is Effection?"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://frontside.com/effection/",children:"Effection"})," is a structured concurrency library for JavaScript/TypeScript that treats asynchronous operations as first-class values called ",(0,s.jsx)(n.strong,{children:"Operations"}),". It provides:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Automatic resource cleanup"}),": When an operation ends, all spawned child operations are automatically cancelled"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Structured concurrency"}),": Operations form a tree where parent operations control child lifecycles"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Graceful shutdown"}),": Cancelling a parent operation gracefully shuts down all children"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Error propagation"}),": Errors bubble up the operation tree predictably"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"why-use-effection-with-the-batcher",children:"Why Use Effection with the Batcher?"}),"\n",(0,s.jsx)(n.p,{children:"The batcher has two long-running concurrent tasks:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"HTTP Server"})," - Accepts incoming requests"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Polling Loop"})," - Periodically checks batching criteria"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Effection ensures that:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Both tasks start together"}),"\n",(0,s.jsx)(n.li,{children:"If one fails, the other is automatically stopped"}),"\n",(0,s.jsx)(n.li,{children:"On shutdown (Ctrl+C), both tasks are gracefully cancelled"}),"\n",(0,s.jsx)(n.li,{children:"Resources (server sockets, timers) are automatically cleaned up"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Without structured concurrency, you'd need manual bookkeeping to track and stop these tasks."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.p,{children:"Effection is available on both NPM and Deno:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"NPM/Yarn:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npm install effection\n# or\nyarn add effection\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Deno:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { main, suspend } from "https://jsr.io/@effection/effection/doc";\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"using-runbatcher-with-effection",children:["Using ",(0,s.jsx)(n.code,{children:"runBatcher()"})," with Effection"]}),"\n",(0,s.jsxs)(n.p,{children:["The batcher provides a ",(0,s.jsx)(n.code,{children:"runBatcher()"})," operation that:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Initializes storage"}),"\n",(0,s.jsx)(n.li,{children:"Spawns the HTTP server (if enabled)"}),"\n",(0,s.jsx)(n.li,{children:"Spawns the polling loop"}),"\n",(0,s.jsx)(n.li,{children:"Keeps both running until cancelled"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"basic-example",children:"Basic Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { main, suspend } from "effection";\nimport { PaimaBatcher } from "@effectstream/batcher";\n\nconst batcher = new PaimaBatcher(config, storage);\n\nmain(function* () {\n  // Run the batcher (starts HTTP server and polling)\n  yield* batcher.runBatcher();\n  \n  // Keep the main operation alive\n  yield* suspend();\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"What happens:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"main()"})," creates the root operation scope"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"batcher.runBatcher()"})," spawns HTTP server and polling loop"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"suspend()"})," keeps the operation alive indefinitely"]}),"\n",(0,s.jsx)(n.li,{children:"On Ctrl+C or error, Effection cancels all operations gracefully"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"complete-example-with-event-listeners",children:"Complete Example with Event Listeners"}),"\n",(0,s.jsx)(n.p,{children:"Here's a production-ready example from the E2E tests:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { main, suspend } from "effection";\nimport { PaimaBatcher } from "@effectstream/batcher";\nimport { config, storage } from "./config.ts";\n\nconst batcher = new PaimaBatcher(config, storage);\n\n// Add event listeners before starting\nbatcher.addStateTransition("startup", ({ publicConfig }) => {\n  console.log(`\ud83d\ude80 Batcher started`);\n  console.log(`   Default Target: ${publicConfig.defaultTarget}`);\n  console.log(`   Adapters: ${publicConfig.adapterTargets.join(", ")}`);\n  console.log(`   Polling: ${publicConfig.pollingIntervalMs}ms`);\n});\n\nbatcher.addStateTransition("http:start", ({ port }) => {\n  console.log(`\ud83c\udf10 HTTP Server: http://localhost:${port}`);\n  console.log(`\ud83d\udcd6 Docs: http://localhost:${port}/documentation`);\n});\n\nbatcher.addStateTransition("error", ({ phase, error }) => {\n  console.error(`\u274c Error in ${phase}:`, error);\n});\n\nmain(function* () {\n  console.log("\ud83d\ude80 Starting Batcher...");\n  \n  try {\n    // Run the batcher with Effection structured concurrency\n    yield* batcher.runBatcher();\n  } catch (error) {\n    console.error("\u274c Batcher error:", error);\n    // Trigger graceful shutdown on error\n    yield* batcher.gracefulShutdownOp();\n  }\n  \n  // Keep the main operation alive\n  yield* suspend();\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Output:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\ud83d\ude80 Starting Batcher...\n\ud83d\ude80 Batcher started\n   Default Target: ethereum\n   Adapters: ethereum, polygon\n   Polling: 1000ms\n\ud83c\udf10 HTTP Server: http://localhost:3334\n\ud83d\udcd6 Docs: http://localhost:3334/documentation\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"alternative-manual-initialization",children:"Alternative: Manual Initialization"}),"\n",(0,s.jsx)(n.p,{children:"If you need more control, you can initialize manually:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { main, suspend, spawn, sleep, call } from "effection";\n\nconst batcher = new PaimaBatcher(config, storage);\n\nmain(function* () {\n  // 1. Initialize storage\n  yield* call(() => batcher.storage.init());\n  batcher.isInitialized = true;\n  \n  // 2. Emit startup event\n  yield* batcher.emitStateTransition("startup", {\n    publicConfig: batcher.getPublicConfig(),\n    time: Date.now()\n  });\n  \n  // 3. Start HTTP server (if enabled)\n  if (config.enableHttpServer) {\n    yield* spawn(() => batcher.runHttpServer());\n  }\n  \n  // 4. Start polling loop\n  yield* spawn(function* () {\n    while (true) {\n      yield* sleep(config.pollingIntervalMs);\n      yield* call(() => batcher.pollBatcher());\n    }\n  });\n  \n  yield* suspend();\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"When to use this:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"You need to perform custom initialization steps"}),"\n",(0,s.jsx)(n.li,{children:"You want to add middleware between initialization and startup"}),"\n",(0,s.jsx)(n.li,{children:"You're integrating with other Effection-based systems"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"graceful-shutdown-with-effection",children:"Graceful Shutdown with Effection"}),"\n",(0,s.jsx)(n.p,{children:"Effection automatically handles Ctrl+C (SIGINT) and SIGTERM signals:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"main(function* () {\n  yield* batcher.runBatcher();\n  yield* suspend();\n});\n// Press Ctrl+C:\n// 1. Effection cancels all operations\n// 2. HTTP server stops\n// 3. Polling loop stops\n// 4. Batcher cleanup runs\n// 5. Process exits\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"For custom shutdown logic"}),", use ",(0,s.jsx)(n.code,{children:"gracefulShutdownOp()"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'main(function* () {\n  try {\n    yield* batcher.runBatcher();\n    yield* suspend();\n  } finally {\n    // Always runs on cancellation\n    console.log("Shutting down...");\n    yield* batcher.gracefulShutdownOp({\n      cleanup: async () => {\n        console.log("Custom cleanup");\n        await database.disconnect();\n      }\n    });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(n.p,{children:"Effection propagates errors up the operation tree:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'main(function* () {\n  try {\n    yield* batcher.runBatcher();\n    yield* suspend();\n  } catch (error) {\n    // Catch errors from HTTP server or polling loop\n    console.error("Batcher failed:", error);\n    \n    // Attempt graceful shutdown\n    try {\n      yield* batcher.gracefulShutdownOp();\n    } catch (shutdownError) {\n      console.error("Shutdown failed:", shutdownError);\n    }\n    \n    // Re-throw or exit\n    throw error;\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Error scenarios:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"HTTP server fails to start"}),": Error caught, shutdown triggered"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Polling loop throws"}),": Error caught, HTTP server automatically stopped"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Adapter submission fails"}),": Error logged, polling continues (errors don't crash the batcher)"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"running-multiple-batchers",children:"Running Multiple Batchers"}),"\n",(0,s.jsx)(n.p,{children:"Use Effection to run multiple batcher instances:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { main, suspend, spawn } from "effection";\n\nconst batcher1 = new PaimaBatcher(config1, storage1);\nconst batcher2 = new PaimaBatcher(config2, storage2);\n\nmain(function* () {\n  // Run both batchers concurrently\n  yield* spawn(() => batcher1.runBatcher());\n  yield* spawn(() => batcher2.runBatcher());\n  \n  console.log("Both batchers running");\n  yield* suspend();\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:"If either batcher fails, both are automatically stopped."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"effection-operations-reference",children:"Effection Operations Reference"}),"\n",(0,s.jsx)(n.p,{children:"The batcher provides these Effection operations:"}),"\n",(0,s.jsx)(n.h4,{id:"runbatcher-operationvoid",children:(0,s.jsx)(n.code,{children:"runBatcher(): Operation<void>"})}),"\n",(0,s.jsx)(n.p,{children:"Complete batcher lifecycle: initialize storage, start HTTP server, start polling loop."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"main(function* () {\n  yield* batcher.runBatcher();\n  yield* suspend();\n});\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"runhttpserver-operationvoid",children:(0,s.jsx)(n.code,{children:"runHttpServer(): Operation<void>"})}),"\n",(0,s.jsx)(n.p,{children:"Start only the HTTP server (useful for custom setups)."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"main(function* () {\n  yield* call(() => batcher.storage.init());\n  yield* batcher.runHttpServer();  // Just HTTP, no polling\n  yield* suspend();\n});\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"runpollingloop-operationvoid",children:(0,s.jsx)(n.code,{children:"runPollingLoop(): Operation<void>"})}),"\n",(0,s.jsx)(n.p,{children:"Start only the polling loop (useful for custom setups)."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"main(function* () {\n  yield* call(() => batcher.storage.init());\n  yield* batcher.runPollingLoop();  // Just polling, no HTTP\n  yield* suspend();\n});\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"gracefulshutdownophooks-options-operationvoid",children:(0,s.jsx)(n.code,{children:"gracefulShutdownOp(hooks?, options?): Operation<void>"})}),"\n",(0,s.jsx)(n.p,{children:"Gracefully shut down the batcher with custom hooks."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'main(function* () {\n  yield* batcher.runBatcher();\n  \n  // Somewhere else, trigger shutdown:\n  yield* batcher.gracefulShutdownOp({\n    cleanup: async () => {\n      console.log("Cleaning up...");\n    }\n  }, { timeoutMs: 30000 });\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h4,{id:"emitstatetransitionprefix-payload-operationvoid",children:(0,s.jsx)(n.code,{children:"emitStateTransition(prefix, payload): Operation<void>"})}),"\n",(0,s.jsx)(n.p,{children:"Emit state transition events (used internally)."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'main(function* () {\n  yield* batcher.emitStateTransition("custom:event", {\n    message: "Something happened",\n    time: Date.now()\n  });\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.h4,{id:"1-always-use-main-for-production",children:["1. Always Use ",(0,s.jsx)(n.code,{children:"main()"})," for Production"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// \u2705 Good: Structured concurrency\nmain(function* () {\n  yield* batcher.runBatcher();\n  yield* suspend();\n});\n\n// \u274c Bad: Manual async/await\nasync function run() {\n  await batcher.init();\n  // No automatic cleanup, shutdown logic required\n}\nrun();\n"})}),"\n",(0,s.jsxs)(n.h4,{id:"2-use-spawn-for-background-tasks",children:["2. Use ",(0,s.jsx)(n.code,{children:"spawn()"})," for Background Tasks"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'main(function* () {\n  yield* batcher.runBatcher();\n  \n  // Run metrics collector in background\n  yield* spawn(function* () {\n    while (true) {\n      yield* sleep(60000);\n      const stats = yield* call(() => batcher.getBatchingStatus());\n      metrics.gauge("queue.size", stats.totalPendingInputs);\n    }\n  });\n  \n  yield* suspend();\n});\n'})}),"\n",(0,s.jsx)(n.h4,{id:"3-handle-errors-gracefully",children:"3. Handle Errors Gracefully"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'main(function* () {\n  try {\n    yield* batcher.runBatcher();\n    yield* suspend();\n  } catch (error) {\n    console.error("Fatal error:", error);\n    yield* batcher.gracefulShutdownOp();\n    Deno.exit(1);  // or process.exit(1) in Node\n  }\n});\n'})}),"\n",(0,s.jsx)(n.h4,{id:"4-add-event-listeners-before-starting",children:"4. Add Event Listeners Before Starting"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// \u2705 Good: Listeners registered before runBatcher()\nbatcher.addStateTransition("startup", () => console.log("Started"));\nmain(function* () {\n  yield* batcher.runBatcher();\n});\n\n// \u26a0\ufe0f Bad: Listener might miss startup event\nmain(function* () {\n  yield* batcher.runBatcher();\n  batcher.addStateTransition("startup", () => console.log("Started"));\n});\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"comparison-effection-vs-manual-asyncawait",children:"Comparison: Effection vs Manual Async/Await"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Manual Async/Await:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"async function runBatcher() {\n  await batcher.init();\n  \n  // Start HTTP server\n  const server = await batcher.startHttpServer();\n  \n  // Start polling\n  const pollingInterval = setInterval(() => {\n    batcher.pollBatcher().catch(console.error);\n  }, 1000);\n  \n  // Handle shutdown\n  process.on('SIGINT', async () => {\n    clearInterval(pollingInterval);\n    await server.close();\n    await batcher.gracefulShutdown();\n    process.exit(0);\n  });\n}\nrunBatcher();\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Problems:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Manual cleanup tracking"}),"\n",(0,s.jsx)(n.li,{children:"Race conditions in shutdown"}),"\n",(0,s.jsx)(n.li,{children:"Error handling is complex"}),"\n",(0,s.jsx)(n.li,{children:"No automatic resource cleanup"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"With Effection:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"main(function* () {\n  yield* batcher.runBatcher();\n  yield* suspend();\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Automatic cleanup"}),"\n",(0,s.jsx)(n.li,{children:"Structured shutdown"}),"\n",(0,s.jsx)(n.li,{children:"Error propagation"}),"\n",(0,s.jsx)(n.li,{children:"4 lines instead of 20+"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:"This guide covered five advanced topics:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"HTTP API"}),": REST endpoints for input submission (",(0,s.jsx)(n.code,{children:"/send-input"}),"), monitoring (",(0,s.jsx)(n.code,{children:"/status"}),", ",(0,s.jsx)(n.code,{children:"/queue-stats"}),"), and developer operations (",(0,s.jsx)(n.code,{children:"/force-batch"}),", ",(0,s.jsx)(n.code,{children:"/clear-inputs"}),")"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Batching Criteria"}),": Five strategies for controlling batch submission timing\u2014time, size, value, hybrid, and custom\u2014each with distinct use cases"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Event System"}),": Lifecycle hooks for observability, emitting events like ",(0,s.jsx)(n.code,{children:"startup"}),", ",(0,s.jsx)(n.code,{children:"batch:submit"}),", ",(0,s.jsx)(n.code,{children:"batch:receipt"}),", and ",(0,s.jsx)(n.code,{children:"error"})," for monitoring and integration"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Storage System"}),": The ",(0,s.jsx)(n.code,{children:"BatcherStorage"})," interface enables pluggable persistence backends, with ",(0,s.jsx)(n.code,{children:"FileStorage"})," for development and custom implementations for production (PostgreSQL, Redis, etc.)"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Effection Integration"}),": Structured concurrency using ",(0,s.jsx)(n.code,{children:"main()"})," and ",(0,s.jsx)(n.code,{children:"runBatcher()"})," for automatic resource cleanup, graceful shutdown, and robust error handling"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Together, these features provide the foundation for building production-grade batching systems with observability, flexibility, and reliability."}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Review ",(0,s.jsx)(n.a,{href:"/docs/home/components/batcher/configuration",children:"Configuration"})," for complete setup options"]}),"\n",(0,s.jsxs)(n.li,{children:["Explore ",(0,s.jsx)(n.a,{href:"/docs/home/components/batcher/adapter",children:"Custom Adapters"})," to support new blockchains"]}),"\n",(0,s.jsxs)(n.li,{children:["Study ",(0,s.jsx)(n.a,{href:"/docs/home/components/batcher/core-concepts",children:"Core Concepts"})," for architectural understanding"]}),"\n",(0,s.jsxs)(n.li,{children:["Check ",(0,s.jsx)(n.a,{href:"/docs/home/components/batcher/batching-pipeline",children:"The Batching Pipeline"})," for input lifecycle details"]}),"\n",(0,s.jsxs)(n.li,{children:["Read ",(0,s.jsx)(n.a,{href:"https://frontside.com/effection/",children:"Effection Documentation"})," for advanced concurrency patterns"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},6613:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var r=t(1491);const s={},i=r.createContext(s);function a(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);