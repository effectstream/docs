<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-home/templates/intent-swap" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Night-Bitcoin (Intents Swap) | Effectstream</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://effectstream.github.io/docs/ja/img/no-image.png"><meta data-rh="true" name="twitter:image" content="https://effectstream.github.io/docs/ja/img/no-image.png"><meta data-rh="true" property="og:url" content="https://effectstream.github.io/docs/ja/home/templates/intent-swap"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Night-Bitcoin (Intents Swap) | Effectstream"><meta data-rh="true" name="description" content="-   Location: /templates/night-bitcoin"><meta data-rh="true" property="og:description" content="-   Location: /templates/night-bitcoin"><link data-rh="true" rel="icon" href="/docs/ja/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://effectstream.github.io/docs/ja/home/templates/intent-swap"><link data-rh="true" rel="alternate" href="https://effectstream.github.io/docs/home/templates/intent-swap" hreflang="en"><link data-rh="true" rel="alternate" href="https://effectstream.github.io/docs/ja/home/templates/intent-swap" hreflang="ja"><link data-rh="true" rel="alternate" href="https://effectstream.github.io/docs/home/templates/intent-swap" hreflang="x-default"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><link rel="stylesheet" href="/docs/ja/assets/css/styles.3561bdc5.css">
<script src="/docs/ja/assets/js/runtime~main.33999d93.js" defer="defer"></script>
<script src="/docs/ja/assets/js/main.63c99f3c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs/ja/img/favicon.ico"><div role="region" aria-label="„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åæ„Åß„Çπ„Ç≠„ÉÉ„Éó"><a class="skipToContent_LRwd" href="#__docusaurus_skipToContent_fallback">„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åæ„Åß„Çπ„Ç≠„ÉÉ„Éó</a></div><div class="theme-announcement-bar announcementBar_llC7" style="background-color:#fffcf9;color:#ef476f" role="banner"><div class="content_Pagn announcementBarContent_QHqT">
      <div class="custom-banner">
        <p><strong>You are looking at Effectstream v2 docs</strong></p>
        <p>Effectstream v2 is still under constructionüöß</p>
      </div>
    </div></div><nav aria-label="„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº„ÇíÈñã„Åè" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/docs/ja/"><div class="navbar__logo"><img src="/docs/ja/img/favicon.ico" alt="Effectstream logo" class="themedComponent_m_92 themedComponent--light_mRW5"><img src="/docs/ja/img/favicon.ico" alt="Effectstream logo" class="themedComponent_m_92 themedComponent--dark_iQ27"></div><b class="navbar__title text--truncate">Effectstream</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_J6rI"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>Japanese</a><ul class="dropdown__menu"><li><a href="/docs/home/templates/intent-swap" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/docs/ja/home/templates/intent-swap" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ja">Japanese</a></li></ul></div><div class="navbarSearchContainer_E3Re"><div class="navbar__search searchBarContainer_sERs" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_s8y1 searchBarLoadingRing_W2S3"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_Gcnp"><div class="docsWrapper_xhHm"><button aria-label="ÂÖàÈ†≠„Å∏Êàª„Çã" class="clean-btn theme-back-to-top-button backToTopButton_P6dF" type="button"></button><div class="docRoot_QZFe"><aside class="theme-doc-sidebar-container docSidebarContainer_z8Xi"><div class="sidebarViewport_LtND"><div class="sidebar_eBd7"><nav aria-label="„Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆ„Çµ„Ç§„Éâ„Éê„Éº" class="menu thin-scrollbar menu_sQgX menuWithAnnouncementBar_IFIy"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docs/ja/">Intro</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ja/what-is-effectstream">What is Effectstream?</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/ja/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/ja/home/components/">Components</a><button aria-label="&#x27;Components&#x27;„ÅÆÁõÆÊ¨°„ÇíÈñã„Åè" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/ja/home/chains/">Chains</a><button aria-label="&#x27;Chains&#x27;„ÅÆÁõÆÊ¨°„ÇíÈñã„Åè" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/ja/home/deployment/deploy-game">Deployment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/ja/home/paima-standards/">Paima Standards (PRCs)</a><button aria-label="&#x27;Paima Standards (PRCs)&#x27;„ÅÆÁõÆÊ¨°„ÇíÈñã„Åè" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/ja/home/effectstream-engine/">Architecture</a><button aria-label="&#x27;Architecture&#x27;„ÅÆÁõÆÊ¨°„ÇíÈñã„Åè" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/ja/home/templates/evm-midnight">Templates</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ja/home/templates/evm-midnight">EVM-Midnight Token Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ja/home/templates/wallets">Web Wallets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ja/home/templates/chess">Chess (Game)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ja/home/templates/multi-chain-swap">Multi-Chain Token Swap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/ja/home/templates/intent-swap">Night-Bitcoin (Intents Swap)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ja/home/templates/example-tarochi">Tarochi (Game)</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://github.com/PaimaStudios/paima-game-templates" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_TdTm">Paima Game Templates<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_Y7wO"><use href="#theme-svg-external-link"></use></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://github.com/PaimaStudios/paima-engine/" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_TdTm">Effectstream Github<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_Y7wO"><use href="#theme-svg-external-link"></use></svg></a></li></ul></nav></div></div></aside><main class="docMainContainer_PnPB"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Haw5"><div class="docItemContainer_OM9T"><article><div class="tocCollapsible_o4j2 theme-doc-toc-mobile tocMobile_PSvY"><button type="button" class="clean-btn tocCollapsibleButton_GQbL">„Åì„ÅÆ„Éö„Éº„Ç∏„ÅÆË¶ãÂá∫„Åó</button></div><div class="theme-doc-markdown markdown"><header><h1>Night-Bitcoin (Intents Swap)</h1></header>
<ul>
<li><strong>Location</strong>: <code>/templates/night-bitcoin</code></li>
<li><strong>Highlights</strong>: Bitcoin &amp; Midnight Interoperability, ERC-7683 Cross-Chain Intents, Solver/Filler Architecture.</li>
</ul>
<p>The <code>night-bitcoin</code> template demonstrates a cutting-edge pattern in Web3: <strong>Intent-Based Cross-Chain Swaps</strong>. It utilizes Effectstream to orchestrate trades between a UTXO-based chain (Bitcoin) and a ZK-privacy chain (Midnight) without a traditional bridge, relying instead on a network of &quot;Fillers&quot; (Solvers) and an intent standard.</p>
<p><img decoding="async" loading="lazy" alt="Night Bitcoin UI" src="/docs/ja/assets/images/1205-ui-a02d8446722564d8e42a2ec6680b8fa3.png" width="1455" height="1213" class="img_UUpp"></p>
<h3 class="anchor anchorWithStickyNavbar_qIhk" id="dapp-video">dApp Video:<a href="#dapp-video" class="hash-link" aria-label="dApp Video: „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="dApp Video: „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h3>
<iframe src="https://drive.google.com/file/d/19rIhqAVBCfjxZrk25xnKU08ffVaCc7RZ/preview" width="640" height="480" allow="autoplay"></iframe>
<h2 class="anchor anchorWithStickyNavbar_qIhk" id="quick-start">Quick Start<a href="#quick-start" class="hash-link" aria-label="Quick Start „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Quick Start „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h2>
<p><strong>Prerequisites</strong>:</p>
<ul>
<li>A Midnight Wallet supporting undeployed networks (e.g., Lace Midnight Preview).</li>
<li>A Bitcoin Wallet supporting Regtest (e.g., Sparrow Wallet).</li>
</ul>
<div class="language-sh codeBlockContainer_Epcf theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_zcFB"><pre tabindex="0" class="prism-code language-sh codeBlock_JaaR thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_O7QW"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Clone the repository</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> clone git@github.com:PaimaStudios/paima-engine.git </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--branch</span><span class="token plain"> v-next effectstream-demo</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> effectstream-demo/templates/night-bitcoin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check for external dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">/check.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Install packages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deno </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> --allow-scripts </span><span class="token operator">&amp;&amp;</span><span class="token plain"> ./patch.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Compile contracts (Compact for Midnight)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deno task build:midnight</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deno task build:bitcoin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Launch Effectstream Node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deno task dev</span><br></span></code></pre></div></div>
<p><strong>Terminal:</strong></p>
<p><img decoding="async" loading="lazy" alt="Terminal" src="/docs/ja/assets/images/1205-terminal-8689e6dd78618134a8596028ceae7e3a.png" width="1722" height="747" class="img_UUpp"></p>
<p>Once the <code>sync</code>process starts, open <a href="http://localhost:10599" target="_blank" rel="noopener noreferrer">http://localhost:10599</a></p>
<h2 class="anchor anchorWithStickyNavbar_qIhk" id="core-concept-intent-flow-overview">Core Concept: Intent flow overview<a href="#core-concept-intent-flow-overview" class="hash-link" aria-label="Core Concept: Intent flow overview „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Core Concept: Intent flow overview „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h2>
<p>Instead of executing a direct transaction to swap tokens, users sign an <strong>Intent</strong>‚Äîa message declaring <em>what</em> they want (e.g., &quot;I offer 1 BTC to receive at least 1000 M20 on Midnight&quot;).</p>
<blockquote>
<p>Note Fillers and Solvers are the same in this example.</p>
</blockquote>
<ol>
<li><strong>Request Quote</strong>: The user requests quotes from off-chain Fillers.</li>
<li><strong>Create Intent</strong>: The user selects the best quote and creates an Intent on the Midnight chain (using the ERC-7683 standard contract).</li>
<li><strong>Payment</strong>: The user sends the source funds (BTC) to the verifier nodes/escrow.</li>
<li><strong>Verification</strong>: The verifier nodes monitor the blockchains. When it detects the Intent on Midnight <em>and</em> the Payment on Bitcoin, it matches them.</li>
<li><strong>Filler Execution</strong>: The Fillers read the Intent and provides the liquidity, sending the funds to the user.</li>
<li><strong>Resolution</strong>: The Verifier Nodes validates the trade and triggers the release of funds to the user and the Fillers.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_qIhk" id="core-concepts-effectstream-mapping">Core Concepts: Effectstream Mapping<a href="#core-concepts-effectstream-mapping" class="hash-link" aria-label="Core Concepts: Effectstream Mapping „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Core Concepts: Effectstream Mapping „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h2>
<ul>
<li>The Verifier Nodes -&gt; is implemented an Effectstream State Machine.</li>
<li>The Fillers -&gt; is implemented as a Effectstream Batcher.</li>
<li>ERC-7683 Contract -&gt; Midnight Contract</li>
</ul>
<p>Once the process starts, open <a href="http://localhost:10599" target="_blank" rel="noopener noreferrer">http://localhost:10599</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_qIhk" id="background-concepts-the-erc-7683-standard">Background Concepts: The ERC-7683 Standard<a href="#background-concepts-the-erc-7683-standard" class="hash-link" aria-label="Background Concepts: The ERC-7683 Standard „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Background Concepts: The ERC-7683 Standard „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h2>
<p>This template leverages <strong>ERC-7683</strong>, a standard interface for cross-chain trade execution systems.</p>
<p><strong>The Problem</strong>
Intent-based systems abstract away the complexity of bridges for users, but they often suffer from fragmented liquidity and isolated networks of &quot;fillers&quot; (solvers). Each protocol usually builds its own proprietary <code>order</code> format, making it difficult for fillers to support multiple chains and dApps efficiently.</p>
<p><strong>The Solution</strong>
ERC-7683 establishes a framework for specifying cross-chain actions. By standardizing the <code>order</code> structure and the settlement interfaces, it allows diverse systems to share infrastructure.</p>
<p><strong>In Night-Bitcoin</strong>
We utilize this standard to define the &quot;Swap Intent&quot; on the Midnight chain. Even though one side of the transaction occurs on Bitcoin (which is non-EVM), the <strong>Midnight contract</strong> acts as the <code>OriginSettler</code> defined in the spec. In this example, we take a simplified approach to the settlement interfaces and resolutions.</p>
<h2 class="anchor anchorWithStickyNavbar_qIhk" id="architecture-overview">Architecture Overview<a href="#architecture-overview" class="hash-link" aria-label="Architecture Overview „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Architecture Overview „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h2>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_qIhk" id="the-components-in-action">The Components in Action<a href="#the-components-in-action" class="hash-link" aria-label="The Components in Action „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="The Components in Action „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_qIhk" id="1-on-chain-logic">1. On-Chain Logic<a href="#1-on-chain-logic" class="hash-link" aria-label="1. On-Chain Logic „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="1. On-Chain Logic „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h3>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="midnight-compact">Midnight (Compact)<a href="#midnight-compact" class="hash-link" aria-label="Midnight (Compact) „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Midnight (Compact) „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>The template uses two main contracts located in <code>packages/shared/contracts/midnight-contracts</code>:</p>
<ul>
<li><strong><code>erc7683.compact</code></strong>: Implements the standard for Cross-Chain Intents. It stores the <code>Intent</code> struct containing details like <code>maxSpent</code>, <code>minReceived</code>, and other standard fields.</li>
<li><strong><code>unshielded-erc20.compact</code></strong>: Openzepplin Standard ERC20 Unshielded &quot;M20&quot; token used for swapping against Bitcoin.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="bitcoin">Bitcoin<a href="#bitcoin" class="hash-link" aria-label="Bitcoin „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Bitcoin „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>There are no smart contracts on Bitcoin. Instead, the engine tracks specific P2WPKH (Pay-to-Witness-Public-Key-Hash) addresses and transaction inputs/outputs using the Bitcoin RPC.</p>
<h3 class="anchor anchorWithStickyNavbar_qIhk" id="2-chain-configuration-localhostconfigts">2. Chain Configuration (<code>localhostConfig.ts</code>)<a href="#2-chain-configuration-localhostconfigts" class="hash-link" aria-label="2-chain-configuration-localhostconfigts „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="2-chain-configuration-localhostconfigts „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h3>
<p>The <code>localhostConfig</code> connects the engine to a local Bitcoin Regtest node and a local Midnight node.</p>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="midnight-configuration">Midnight Configuration<a href="#midnight-configuration" class="hash-link" aria-label="Midnight Configuration „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Midnight Configuration „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>This block configures the connection to the local Midnight node, the Indexer sync protocol, and the primitives that monitor the public state of the ZK contracts.</p>
<div class="language-ts codeBlockContainer_Epcf theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_zcFB"><pre tabindex="0" class="prism-code language-ts codeBlock_JaaR thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_O7QW"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// 1. Network Definition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addNetwork</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;midnight&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  type</span><span class="token operator">:</span><span class="token plain"> ConfigNetworkType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">MIDNIGHT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  genesisHash</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0x0000...0001&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  networkId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 0 = Undeployed/Local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  nodeUrl</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://127.0.0.1:9944&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 2. Sync Protocol (via Indexer)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addParallel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">networks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> networks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">midnight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> deployments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;parallelMidnight&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type</span><span class="token operator">:</span><span class="token plain"> ConfigSyncProtocolType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">MIDNIGHT_PARALLEL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pollingInterval</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    indexer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://127.0.0.1:8088/api/v1/graphql&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    indexerWs</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ws://127.0.0.1:8088/api/v1/graphql/ws&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 3. Primitives (Contract State Listeners)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addPrimitive</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">syncProtocols</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> syncProtocols</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">parallelMidnight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> deployments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> syncProtocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;MidnightContractState-ERC7683&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type</span><span class="token operator">:</span><span class="token plain"> PrimitiveTypeMidnightGeneric</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    contractAddress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">readMidnightContract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;erc7683&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;contract-erc7683.json&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">contractAddress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    stateMachinePrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;midnightContractStateERC7683&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    contract</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> ledger</span><span class="token operator">:</span><span class="token plain"> Erc7683Contract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ledger </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addPrimitive</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">syncProtocols</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> syncProtocols</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">parallelMidnight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> deployments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> syncProtocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;MidnightContractState-ERC20&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type</span><span class="token operator">:</span><span class="token plain"> PrimitiveTypeMidnightGeneric</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    contractAddress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">readMidnightContract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;unshielded-erc20&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;contract-unshielded-erc20.json&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">contractAddress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    stateMachinePrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;midnightContractStateERC20&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    contract</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> ledger</span><span class="token operator">:</span><span class="token plain"> UnshieldedErc20Contract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ledger </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="bitcoin-configuration">Bitcoin Configuration<a href="#bitcoin-configuration" class="hash-link" aria-label="Bitcoin Configuration „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Bitcoin Configuration „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>This block configures the connection to the local Bitcoin Core node (Regtest), the RPC sync protocol, and the primitive that watches specific UTXOs.</p>
<div class="language-ts codeBlockContainer_Epcf theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_zcFB"><pre tabindex="0" class="prism-code language-ts codeBlock_JaaR thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_O7QW"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// 1. Network Definition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addNetwork</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;bitcoin&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  type</span><span class="token operator">:</span><span class="token plain"> ConfigNetworkType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">BITCOIN</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  rpcUrl</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://127.0.0.1:18443&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  rpcAuth</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    username</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;dev&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    password</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;devpassword&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  network</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;regtest&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 2. Sync Protocol (via RPC)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addParallel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">networks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> networks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">bitcoin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> deployments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;parallelBitcoin&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type</span><span class="token operator">:</span><span class="token plain"> ConfigSyncProtocolType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">BITCOIN_RPC_PARALLEL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    rpcUrl</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://127.0.0.1:18443&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pollingInterval</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10_000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    confirmationDepth</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 0 for faster dev on regtest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 3. Primitive (Address Watcher)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addPrimitive</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">syncProtocols</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> syncProtocols</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">parallelBitcoin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> deployments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> syncProtocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;BitcoinAddress&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type</span><span class="token operator">:</span><span class="token plain"> PrimitiveTypeBitcoinAddress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    startBlockHeight</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">101</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// The Escrow/System wallet address to watch for payments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    watchAddress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;bcrt1qfv6m6l5s6cgda09yr5nd8rnufkaz59d3aquq03&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    stateMachinePrefix</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;bitcoin-transaction&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_qIhk" id="3-the-state-machine-state-machinets">3. The State Machine (<code>state-machine.ts</code>)<a href="#3-the-state-machine-state-machinets" class="hash-link" aria-label="3-the-state-machine-state-machinets „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="3-the-state-machine-state-machinets „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h3>
<p>The logic is driven by three main <code>State Transition Functions</code>:</p>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="bitcoin-transaction"><code>bitcoin-transaction</code><a href="#bitcoin-transaction" class="hash-link" aria-label="bitcoin-transaction „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="bitcoin-transaction „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>Triggered when funds move on the watched <code>Bitcoin address</code>.</p>
<ul>
<li>Records the transfer in the <code>transfers</code> database table.</li>
<li>Calls <code>checkAndTransferFunds</code> to see if this payment matches a known Intent from Midnight.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="midnightcontractstateerc7683"><code>midnightContractStateERC7683</code><a href="#midnightcontractstateerc7683" class="hash-link" aria-label="midnightcontractstateerc7683 „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="midnightcontractstateerc7683 „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>Triggered when the Midnight <code>Intent</code> contract state changes.</p>
<ul>
<li>Decodes the <code>Intent</code> struct from the public ledger.</li>
<li>Records the intent in the <code>intents</code> database table.</li>
<li>Calls <code>checkAndTransferFunds</code> to see if the payment for this intent has already arrived.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="checkandtransferfunds-internal-helper"><code>checkAndTransferFunds</code> (Internal Helper)<a href="#checkandtransferfunds-internal-helper" class="hash-link" aria-label="checkandtransferfunds-internal-helper „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="checkandtransferfunds-internal-helper „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>This is the core settlement logic, it is called if a new <code>Intent</code> is created or a new <code>BTC Payment</code> or <code>Midnight M20 Payment</code>.</p>
<ol>
<li>It queries the database to find a <code>transfers</code> record and an <code>intents</code> record that match (based on amounts and tokens).</li>
<li>If matched, it updates the status to <code>Resolved</code>.</li>
<li>Notifies the Fillers that the <code>Intent</code> has been matched and the <code>BTC Payment</code> has been secured.</li>
<li>It triggers the settlement payouts (sending M20 to the User and BTC to the Filler).</li>
</ol>
<blockquote>
<p>NOTE: In complete implementation step (3) would require the Filler to again check if the <code>Intent</code> is valid, and then provide liquidity and mark and <code>resolve</code> the intent, and then the <code>Verifier Nodes</code> would work as the <code>Settler</code> to release the funds to the filler.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_qIhk" id="4-fillers-packagesfiller">4. Fillers (<code>packages/filler</code>)<a href="#4-fillers-packagesfiller" class="hash-link" aria-label="4-fillers-packagesfiller „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="4-fillers-packagesfiller „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h3>
<p>The template includes a standalone service that simulates a market of Liquidity Providers. Unlike simple market makers, these Fillers are <strong>active agents</strong> that integrate an embedded <strong>Batcher</strong> to automate the settlement process.</p>
<ul>
<li><strong>Location</strong>: <code>packages/filler</code>.</li>
<li><strong>Orchestration</strong>: The orchestrator launches multiple instances (Alpha Liquidity, Omega Swap, etc.) on different ports to simulate a competitive market.</li>
<li><strong>Embedded Batcher</strong>: Each Filler initializes its own Batcher instance connected to both Bitcoin and Midnight adapters. This allows the Filler to programmatically sign and submit transactions to either chain without manual intervention.</li>
<li><strong>API Endpoints</strong>:<!-- -->
<ul>
<li><code>POST /api/quote</code>: Used by the Frontend to request competitive exchange rates and fees before creating an Intent.</li>
<li><code>POST /api/notify-filler-intent-payment</code>: Used by the Effectstream Node (State Machine) to notify the Filler that a user&#x27;s payment has been verified. Upon receiving this webhook, the Filler automatically queues a transaction via its internal Batcher to pay the user the requested tokens (M20 or BTC).</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="embedded-batcher-setup">Embedded Batcher Setup<a href="#embedded-batcher-setup" class="hash-link" aria-label="Embedded Batcher Setup „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Embedded Batcher Setup „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>Each filler initializes its own Paima Batcher instance. This allows the filler to programmatically execute transactions on both Bitcoin and Midnight using its own unique wallet seeds.</p>
<div class="language-typescript codeBlockContainer_Epcf theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_zcFB"><pre tabindex="0" class="prism-code language-typescript codeBlock_JaaR thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_O7QW"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// packages/filler/index.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 1. Build the Batcher setup with the filler&#x27;s specific credentials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> batcherSetup </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">buildBatcherSetup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  fillerName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">FILLER_NAME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  midnightSeed</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">FILLER_BATCHER_DEFAULTS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">midnightSeed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Unique seed per filler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  bitcoin</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token operator">...</span><span class="token constant" style="color:rgb(189, 147, 249)">FILLER_BATCHER_DEFAULTS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">bitcoin </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 2. Initialize the Batcher with dual adapters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> batcher </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">createNewBatcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">batcherSetup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> batcherSetup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">batcher</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addBlockchainAdapter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;midnight&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> batcherSetup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">midnight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    criteriaType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;size&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> maxBatchSize</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Execute immediately</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addBlockchainAdapter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;bitcoin&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> batcherSetup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">bitcoin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    criteriaType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hybrid&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> timeWindowMs</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">setDefaultTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;midnight&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="quote-generation-endpoint">Quote Generation Endpoint<a href="#quote-generation-endpoint" class="hash-link" aria-label="Quote Generation Endpoint „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Quote Generation Endpoint „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>The filler provides a standard API for the frontend to fetch competitive rates.</p>
<div class="language-typescript codeBlockContainer_Epcf theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_zcFB"><pre tabindex="0" class="prism-code language-typescript codeBlock_JaaR thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_O7QW"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// packages/filler/index.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">post</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/api/quote&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> orderId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> fromToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> toToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> fromAmount </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Calculate custom rate and fee</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> conversionRate </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getConversion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">fromAmount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> fromToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> toToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> fee </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">basisPoints </span><span class="token operator">*</span><span class="token plain"> conversionRate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">10000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Return the signed quote structure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  reply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    orderId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    filler</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">FILLER_NAME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    toAmount</span><span class="token operator">:</span><span class="token plain"> conversionRate </span><span class="token operator">-</span><span class="token plain"> fee</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fee</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="automated-settlement-execution">Automated Settlement Execution<a href="#automated-settlement-execution" class="hash-link" aria-label="Automated Settlement Execution „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Automated Settlement Execution „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>When the Effectstream Node verifies the user&#x27;s payment, it notifies the filler that provided the quote. The filler then uses its embedded batcher to automatically send the counter-assets to the user.</p>
<div class="language-typescript codeBlockContainer_Epcf theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_zcFB"><pre tabindex="0" class="prism-code language-typescript codeBlock_JaaR thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_O7QW"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// packages/filler/index.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">post</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/api/notify-filler-intent-payment&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> orderId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> toAddress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> token </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Programmatically trigger the Batcher to send funds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">token </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;btc&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> batcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">batchInput</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      address</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;filler-btc-wallet&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      input</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">JSON</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">stringify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;transfer&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         toAddress</span><span class="token operator">:</span><span class="token plain"> toAddress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         amount</span><span class="token operator">:</span><span class="token plain"> Math</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">floor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      target</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;bitcoin&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Route to Bitcoin Adapter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">token </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;m20&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> batcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">batchInput</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        address</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;filler-midnight-wallet&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        addressType</span><span class="token operator">:</span><span class="token plain"> AddressType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token constant" style="color:rgb(189, 147, 249)">MIDNIGHT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        input</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">JSON</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">stringify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;transfer&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           toAddress</span><span class="token operator">:</span><span class="token plain"> toAddress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           amount</span><span class="token operator">:</span><span class="token plain"> Math</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">floor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;midnight&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Route to Midnight Adapter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  reply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> status</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;processing&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> orderId </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_qIhk" id="5-database-schema">5. Database Schema<a href="#5-database-schema" class="hash-link" aria-label="5. Database Schema „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="5. Database Schema „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h3>
<p>The database acts as the order book and clearinghouse state:</p>
<ul>
<li><strong><code>intents</code></strong>: Stores ERC-7683 Intent data (Order ID, deadlines, assets involved).</li>
<li><strong><code>transfers</code></strong>: Stores raw on-chain transfers detected (Chain ID, Amount, Token).</li>
<li><strong><code>quotes</code></strong>: Stores the quotes provided by fillers for audit trails.</li>
</ul>
<p>Here is the complete <strong>Database Schema</strong> section, updated with the exact SQL definitions provided and a detailed breakdown of the fields and their specific usage within the application&#x27;s settlement logic.</p>
<h3 class="anchor anchorWithStickyNavbar_qIhk" id="5-database-schema-1">5. Database Schema<a href="#5-database-schema-1" class="hash-link" aria-label="5. Database Schema „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="5. Database Schema „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h3>
<p>The database acts as the central clearinghouse state for the application. It persists the competitive quotes from fillers, tracks raw asset movements across Bitcoin and Midnight, and maintains the authoritative state of the ERC-7683 Intents.</p>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="1-intents-table">1. <code>intents</code> Table<a href="#1-intents-table" class="hash-link" aria-label="1-intents-table „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="1-intents-table „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p><strong>Purpose</strong>: Stores the authoritative state of every ERC-7683 Intent created on the Midnight chain. This table mirrors the <code>ResolvedCrossChainOrder</code> struct defined in the standard.</p>
<table><thead><tr><th style="text-align:left">Field</th><th style="text-align:left">Type</th><th style="text-align:left">Usage &amp; Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>order_id</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left"><strong>Unique Key</strong>. The global identifier for the swap order, derived from the user&#x27;s signature/intent hash.</td></tr><tr><td style="text-align:left"><code>status</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">Tracks the lifecycle: <code>&#x27;0&#x27;</code> (Open/Initialized), <code>&#x27;3&#x27;</code> (Resolved/Closed). Updated by the State Machine upon settlement.</td></tr><tr><td style="text-align:left"><code>user_address</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The Midnight address of the user initiating the swap.</td></tr><tr><td style="text-align:left"><code>max_spent_token</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The asset the user is selling (e.g., &quot;btc&quot;).</td></tr><tr><td style="text-align:left"><code>max_spent_amount</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The amount the user must deposit to the escrow address (e.g., Satoshis).</td></tr><tr><td style="text-align:left"><code>min_received_token</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The asset the user expects to receive (e.g., &quot;m20&quot;).</td></tr><tr><td style="text-align:left"><code>min_received_amount</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The guaranteed amount the user will receive on the destination chain.</td></tr><tr><td style="text-align:left"><code>origin_data</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">Additional data defined by the Origin chain (Midnight), often containing target wallet info for the Fillers.</td></tr><tr><td style="text-align:left"><code>created_at</code></td><td style="text-align:left"><code>TIMESTAMP</code></td><td style="text-align:left">Timestamp of when the intent was created.</td></tr><tr><td style="text-align:left"><code>origin_chain_id</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The chain ID of the origin chain (e.g., &quot;1&quot; for Bitcoin, &quot;9999&quot; for Midnight).</td></tr><tr><td style="text-align:left"><code>open_deadline</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The deadline for the user to open the intent.</td></tr><tr><td style="text-align:left"><code>fill_deadline</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The deadline for the filler to fill the intent.</td></tr><tr><td style="text-align:left"><code>max_spent_recipient</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The recipient address of the user.</td></tr><tr><td style="text-align:left"><code>max_spent_chain_id</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The chain ID of the origin chain (e.g., &quot;1&quot; for Bitcoin, &quot;9999&quot; for Midnight).</td></tr><tr><td style="text-align:left"><code>min_received_recipient</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The recipient address of the user.</td></tr><tr><td style="text-align:left"><code>min_received_chain_id</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The chain ID of the destination chain (e.g., &quot;9999&quot; for Midnight).</td></tr><tr><td style="text-align:left"><code>destination_chain_id</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The chain ID of the destination chain (e.g., &quot;9999&quot; for Midnight).</td></tr><tr><td style="text-align:left"><code>destination_settler</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The address of the destination settler.</td></tr><tr><td style="text-align:left"><code>resolved_by</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">Populated during settlement. Stores the ID of the Filler who successfully claimed and executed this order.</td></tr></tbody></table>
<hr>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="2-transfers-table">2. <code>transfers</code> Table<a href="#2-transfers-table" class="hash-link" aria-label="2-transfers-table „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="2-transfers-table „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p><strong>Purpose</strong>: A unified ledger of <strong>raw asset movements</strong> detected on <em>both</em> Bitcoin and Midnight. The State Machine scans this table to find payments that match open intents.</p>
<table><thead><tr><th style="text-align:left">Field</th><th style="text-align:left">Type</th><th style="text-align:left">Usage &amp; Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>id</code></td><td style="text-align:left"><code>SERIAL</code></td><td style="text-align:left">The unique identifier for the transfer.</td></tr><tr><td style="text-align:left"><code>chain_id</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">Distinguishes the network source: <code>&#x27;1&#x27;</code> for Bitcoin, <code>&#x27;9999&#x27;</code> for Midnight.</td></tr><tr><td style="text-align:left"><code>token</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The asset symbol (e.g., &quot;btc&quot;, &quot;m20&quot;).</td></tr><tr><td style="text-align:left"><code>amount</code></td><td style="text-align:left"><code>NUMERIC</code></td><td style="text-align:left">The raw value transferred.</td></tr><tr><td style="text-align:left"><code>created_at</code></td><td style="text-align:left"><code>TIMESTAMP</code></td><td style="text-align:left">Timestamp of when the transfer was created.</td></tr><tr><td style="text-align:left"><code>to_address</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The recipient address. For valid swaps, this must match the System/Escrow address monitored by Paima.</td></tr><tr><td style="text-align:left"><code>from_address</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The sender&#x27;s address.</td></tr><tr><td style="text-align:left"><code>used</code></td><td style="text-align:left"><code>BOOLEAN</code></td><td style="text-align:left"><strong>Critical Field</strong>. Acts as a semaphore. When the State Machine matches a transfer to an intent, it sets this to <code>TRUE</code> to prevent the same deposit from satisfying multiple orders.</td></tr></tbody></table>
<hr>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="3-quotes-table">3. <code>quotes</code> Table<a href="#3-quotes-table" class="hash-link" aria-label="3-quotes-table „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="3-quotes-table „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p><strong>Purpose</strong>: An audit trail of the off-chain negotiation phase. It records the offers provided by Fillers <em>before</em> the Intent was created on-chain.</p>
<table><thead><tr><th style="text-align:left">Field</th><th style="text-align:left">Type</th><th style="text-align:left">Usage &amp; Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>id</code></td><td style="text-align:left"><code>SERIAL</code></td><td style="text-align:left">The unique identifier for the quote.</td></tr><tr><td style="text-align:left"><code>order_id</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">Links this quote to the finalized Intent in the <code>intents</code> table.</td></tr><tr><td style="text-align:left"><code>filler</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The name or ID of the Filler providing the quote (e.g., &quot;Alpha Liquidity&quot;).</td></tr><tr><td style="text-align:left"><code>from_token</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The asset the user is selling (e.g., &quot;btc&quot;).</td></tr><tr><td style="text-align:left"><code>from_amount</code></td><td style="text-align:left"><code>NUMERIC</code></td><td style="text-align:left">The amount the user must deposit to the escrow address</td></tr><tr><td style="text-align:left"><code>to_token</code></td><td style="text-align:left"><code>TEXT</code></td><td style="text-align:left">The asset the user expects to receive (e.g., &quot;m20&quot;).</td></tr><tr><td style="text-align:left"><code>to_amount</code></td><td style="text-align:left"><code>NUMERIC</code></td><td style="text-align:left">The amount the Filler offered to pay the user (Price).</td></tr><tr><td style="text-align:left"><code>fee</code></td><td style="text-align:left"><code>NUMERIC</code></td><td style="text-align:left">The service fee charged by the filler.</td></tr><tr><td style="text-align:left"><code>created_at</code></td><td style="text-align:left"><code>TIMESTAMP</code></td><td style="text-align:left">Timestamp of when the quote was generated via the API.</td></tr></tbody></table>
<hr>
<h4 class="anchor anchorWithStickyNavbar_qIhk" id="settlement-logic-flow">Settlement Logic Flow<a href="#settlement-logic-flow" class="hash-link" aria-label="Settlement Logic Flow „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Settlement Logic Flow „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h4>
<p>The State Machine uses these tables to perform atomic settlement:</p>
<ol>
<li><strong>Ingestion</strong>:<!-- -->
<ul>
<li><code>intents</code> is populated by the <code>midnightContractStateERC7683</code> primitive when a user submits an intent.</li>
<li><code>transfers</code> is populated by the <code>BitcoinAddress</code> primitive when BTC arrives.</li>
</ul>
</li>
<li><strong>Matching (State Machine)</strong>:<!-- -->
<ul>
<li>It queries for an <strong><code>intent</code></strong> where <code>status = &#x27;0&#x27;</code>.</li>
<li>It queries for a <strong><code>transfer</code></strong> where <code>amount &gt;= intent.max_spent_amount</code> AND <code>token == intent.max_spent_token</code> AND <code>used = FALSE</code>.</li>
</ul>
</li>
<li><strong>Resolution</strong>:<!-- -->
<ul>
<li>If a match is found, it locks the transfer (<code>UPDATE transfers SET used = TRUE</code>).</li>
<li>It marks the intent as resolved (<code>UPDATE intents SET status = &#x27;3&#x27;</code>).</li>
<li>It looks up the winning <code>quote</code> using the <code>order_id</code> to determine which Filler to pay.</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_qIhk" id="6-api-apits">6. API (<code>api.ts</code>)<a href="#6-api-apits" class="hash-link" aria-label="6-api-apits „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="6-api-apits „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h3>
<p>The API layer aggregates data for the Frontend:</p>
<ul>
<li><code>POST /api/get-quotes</code>: Proxies requests to the active Filler services to get the best price for the user.</li>
<li><code>GET /api/intents</code>: Returns the status of a specific Order ID.</li>
<li><code>GET /api/faucet/btc</code> &amp; <code>/api/faucet/dust</code>: Development endpoints to fund test wallets.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_qIhk" id="frontend-integration">Frontend Integration<a href="#frontend-integration" class="hash-link" aria-label="Frontend Integration „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ" title="Frontend Integration „Å∏„ÅÆÁõ¥Êé•„É™„É≥„ÇØ">‚Äã</a></h2>
<p>The frontend (<code>packages/frontend/dApp</code>) is a React application that:</p>
<ol>
<li>Connects to a <strong>Midnight Wallet</strong> (Lace) to sign Intents.</li>
<li>Connects to a <strong>Bitcoin Wallet</strong> (via manual address entry for this demo) to send payments.</li>
<li>Interacts with the <strong>Fillers</strong> to fetch quotes.</li>
<li>Monitors the <strong>Effectstream API</strong> to track the status of the swap.</li>
</ol>
<div class="language-tsx codeBlockContainer_Epcf theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_zcFB"><pre tabindex="0" class="prism-code language-tsx codeBlock_JaaR thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_O7QW"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Example: Creating an intent on Midnight</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> intentConfig </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  user</span><span class="token operator">:</span><span class="token plain"> midnightWallet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">addr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  orderId</span><span class="token operator">:</span><span class="token plain"> selectedQuote</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">orderId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  maxSpent_token</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;btc&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  minReceived_token</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;m20&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> intentResult </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">createIntent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    midnightWallet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">contract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">erc7683</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    midnightWallet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">addr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    intentConfig</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/PaimaStudios/paima-engine-docs/tree/main/docs/home/1200-templates/1205-intent-swap.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_uRRq" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÁ∑®ÈõÜ</a></div><div class="col lastUpdated_xDOh"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="„Éâ„Ç≠„É•„É°„É≥„Éà„Éö„Éº„Ç∏"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/ja/home/templates/multi-chain-swap"><div class="pagination-nav__sublabel">Ââç„Å∏</div><div class="pagination-nav__label">Multi-Chain Token Swap</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/ja/home/templates/example-tarochi"><div class="pagination-nav__sublabel">Ê¨°„Å∏</div><div class="pagination-nav__label">Tarochi (Game)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Fe6u thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#dapp-video" class="table-of-contents__link toc-highlight">dApp Video:</a></li><li><a href="#quick-start" class="table-of-contents__link toc-highlight">Quick Start</a></li><li><a href="#core-concept-intent-flow-overview" class="table-of-contents__link toc-highlight">Core Concept: Intent flow overview</a></li><li><a href="#core-concepts-effectstream-mapping" class="table-of-contents__link toc-highlight">Core Concepts: Effectstream Mapping</a></li><li><a href="#background-concepts-the-erc-7683-standard" class="table-of-contents__link toc-highlight">Background Concepts: The ERC-7683 Standard</a></li><li><a href="#architecture-overview" class="table-of-contents__link toc-highlight">Architecture Overview</a></li><li><a href="#the-components-in-action" class="table-of-contents__link toc-highlight">The Components in Action</a><ul><li><a href="#1-on-chain-logic" class="table-of-contents__link toc-highlight">1. On-Chain Logic</a></li><li><a href="#2-chain-configuration-localhostconfigts" class="table-of-contents__link toc-highlight">2. Chain Configuration (<code>localhostConfig.ts</code>)</a></li><li><a href="#3-the-state-machine-state-machinets" class="table-of-contents__link toc-highlight">3. The State Machine (<code>state-machine.ts</code>)</a></li><li><a href="#4-fillers-packagesfiller" class="table-of-contents__link toc-highlight">4. Fillers (<code>packages/filler</code>)</a></li><li><a href="#5-database-schema" class="table-of-contents__link toc-highlight">5. Database Schema</a></li><li><a href="#5-database-schema-1" class="table-of-contents__link toc-highlight">5. Database Schema</a></li><li><a href="#6-api-apits" class="table-of-contents__link toc-highlight">6. API (<code>api.ts</code>)</a></li></ul></li><li><a href="#frontend-integration" class="table-of-contents__link toc-highlight">Frontend Integration</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2025 Midnight Foundation. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>