"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[7986],{3154:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"home/templates/world-map-2d","title":"World Map 2D (Open World Game)","description":"Path*: /templates/world-map-2d","source":"@site/docs/home/1200-templates/1206-world-map-2d.md","sourceDirName":"home/1200-templates","slug":"/home/templates/world-map-2d","permalink":"/docs/ja/home/templates/world-map-2d","draft":false,"unlisted":false,"editUrl":"https://github.com/PaimaStudios/paima-engine-docs/tree/main/docs/home/1200-templates/1206-world-map-2d.md","tags":[],"version":"current","sidebarPosition":1206,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Night-Bitcoin (Intents Swap)","permalink":"/docs/ja/home/templates/intent-swap"},"next":{"title":"Tarochi (Game)","permalink":"/docs/ja/home/templates/example-tarochi"}}');var r=s(2531),i=s(6613);const l={},a="World Map 2D (Open World Game)",d={},o=[{value:"Core Concept: Grid-Based Open World",id:"core-concept-grid-based-open-world",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Frontend Setup",id:"frontend-setup",level:3},{value:"Using Test Accounts",id:"using-test-accounts",level:3},{value:"Docker Setup",id:"docker-setup",level:2},{value:"Building the Docker Image",id:"building-the-docker-image",level:3},{value:"Running the Container",id:"running-the-container",level:3},{value:"Debugging Docker Issues",id:"debugging-docker-issues",level:3},{value:"The Components in Action",id:"the-components-in-action",level:2},{value:"On-Chain Logic",id:"on-chain-logic",level:2},{value:"The State Machine (<code>state-machine.ts</code>)",id:"the-state-machine-state-machinets",level:2},{value:"Grammar Definition",id:"grammar-definition",level:3},{value:"State Transitions",id:"state-transitions",level:3},{value:"<code>joinWorld</code>",id:"joinworld",level:4},{value:"<code>submitMove</code>",id:"submitmove",level:4},{value:"<code>submitIncrement</code>",id:"submitincrement",level:4},{value:"Database Schema",id:"database-schema",level:2},{value:"<code>global_user_state</code>",id:"global_user_state",level:3},{value:"<code>global_world_state</code>",id:"global_world_state",level:3},{value:"Type-Safe Queries",id:"type-safe-queries",level:3},{value:"API Endpoints",id:"api-endpoints",level:2},{value:"GET <code>/user_stats?wallet=&lt;address&gt;</code>",id:"get-user_statswalletaddress",level:3},{value:"GET <code>/world_stats</code>",id:"get-world_stats",level:3},{value:"Frontend Architecture",id:"frontend-architecture",level:2},{value:"Wallet Middleware",id:"wallet-middleware",level:3},{value:"Building the Frontend",id:"building-the-frontend",level:3},{value:"Architecture Highlights",id:"architecture-highlights",level:2},{value:"Generator Function Pattern",id:"generator-function-pattern",level:3},{value:"Separation of Concerns",id:"separation-of-concerns",level:3},{value:"Use Cases and Extensions",id:"use-cases-and-extensions",level:2},{value:"Exploration Games",id:"exploration-games",level:3},{value:"Territory Control",id:"territory-control",level:3},{value:"Multiplayer Interactions",id:"multiplayer-interactions",level:3},{value:"Puzzle Games",id:"puzzle-games",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Port Conflicts",id:"port-conflicts",level:3},{value:"Frontend Bundle Outdated",id:"frontend-bundle-outdated",level:3},{value:"Database Query Types Out of Sync",id:"database-query-types-out-of-sync",level:3},{value:"Learn More",id:"learn-more",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"world-map-2d-open-world-game",children:"World Map 2D (Open World Game)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Path"}),": ",(0,r.jsx)(n.code,{children:"/templates/world-map-2d"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Highlights"}),": A 2D open-world exploration game showcasing spatial game state, movement mechanics, and world interaction using Effectstream's L2."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"world-map-2d"})," template demonstrates how to build an open-world game where players can explore a 2D grid-based world. It's an excellent example for games requiring spatial state management, player movement, and location-based interactions, all processed deterministically through an Effectstream L2 contract on an EVM chain."]}),"\n",(0,r.jsx)(n.p,{children:"Screenshot of running application:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Docker Setup Running",src:s(9605).A+"",width:"2046",height:"1802"})}),"\n",(0,r.jsx)(n.h2,{id:"core-concept-grid-based-open-world",children:"Core Concept: Grid-Based Open World"}),"\n",(0,r.jsx)(n.p,{children:"The goal of this template is to demonstrate an open-world game where players move freely across a 10\xd710 grid and interact with specific locations. The game state tracks both individual player positions and aggregate world statistics."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Player State"}),": Each player has an (x, y) position on the grid that updates as they move."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"World State"}),": A 10\xd710 grid where each cell tracks how many times it has been visited."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Player Actions"}),": All actions (joining the world, moving, incrementing counters) are submitted to a ",(0,r.jsx)(n.code,{children:"Effectstream L2 Contract"})," on an EVM chain."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Backend Logic"}),": The state machine processes these inputs to update positions, validate movements, and maintain world statistics."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This template serves as a foundation for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tile-based exploration games"}),"\n",(0,r.jsx)(n.li,{children:"Location-based multiplayer experiences"}),"\n",(0,r.jsx)(n.li,{children:"Spatial puzzle games"}),"\n",(0,r.jsx)(n.li,{children:"Territory control mechanics"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# Install dependencies\ndeno install --allow-scripts && ./patch.sh\n\n# Build EVM contracts\ndeno task build:evm\n\n# Start the Effectstream Node\ndeno task dev\n"})}),"\n",(0,r.jsx)(n.h3,{id:"frontend-setup",children:"Frontend Setup"}),"\n",(0,r.jsx)(n.p,{children:"In a separate terminal:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"cd packages/frontend\nnpm install\nnode esbuild.js      # Build the frontend bundle\nnpx http-server .    # Serve on http://127.0.0.1:8080\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or use the Deno task:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"deno task -f @world-map-2d/frontend dev\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Then open ",(0,r.jsx)(n.a,{href:"http://127.0.0.1:8080",children:"http://127.0.0.1:8080"})," in your browser."]}),"\n",(0,r.jsx)(n.h3,{id:"using-test-accounts",children:"Using Test Accounts"}),"\n",(0,r.jsx)(n.p,{children:"For development, import Hardhat's test account into MetaMask:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Open MetaMask \u2192 Click account icon \u2192 ",(0,r.jsx)(n.strong,{children:"Import Account"})]}),"\n",(0,r.jsxs)(n.li,{children:["Select ",(0,r.jsx)(n.strong,{children:"Private Key"})," and paste:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["This gives you access to Account #0 with ",(0,r.jsx)(n.strong,{children:"10,000 ETH"})," on your local network"]}),"\n",(0,r.jsxs)(n.li,{children:["Make sure MetaMask is connected to ",(0,r.jsx)(n.strong,{children:"Localhost 8545"})," (Chain ID: 31337)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u26a0\ufe0f ",(0,r.jsx)(n.strong,{children:"Never use this private key on a real network"})," - it's publicly known and only for local development."]}),"\n",(0,r.jsx)(n.h2,{id:"docker-setup",children:"Docker Setup"}),"\n",(0,r.jsx)(n.p,{children:"You can run the entire stack (EVM node, Effectstream backend, and frontend) in a single Docker container:"}),"\n",(0,r.jsx)(n.h3,{id:"building-the-docker-image",children:"Building the Docker Image"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# For macOS\nDOCKER_DEFAULT_PLATFORM=linux/amd64 docker build -t world-map-2d-sample -f Dockerfile .\n\n# For Linux\ndocker build -t world-map-2d-sample -f Dockerfile .\n"})}),"\n",(0,r.jsx)(n.p,{children:"This will:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Install all dependencies (Deno, Node.js, Foundry)"}),"\n",(0,r.jsx)(n.li,{children:"Build the EVM contracts"}),"\n",(0,r.jsx)(n.li,{children:"Build the frontend bundle"}),"\n",(0,r.jsx)(n.li,{children:"Set up the launch script"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"running-the-container",children:"Running the Container"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# For macOS\nDOCKER_DEFAULT_PLATFORM=linux/amd64 docker run -p 8080:8080 -p 8545:8545 -p 9999:9999 -p 3334:3334 world-map-2d-sample\n\n# For Linux\ndocker run -p 8080:8080 -p 8545:8545 -p 9999:9999 -p 3334:3334 world-map-2d-sample\n"})}),"\n",(0,r.jsx)(n.p,{children:"The container exposes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Port 8080"}),": Frontend (",(0,r.jsx)(n.a,{href:"http://localhost:8080",children:"http://localhost:8080"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Port 8545"}),": Local EVM node (Hardhat)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Port 9999"}),": Effectstream backend API"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Port 3334"}),": Explorer"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Once the container is running, you'll see the Effectstream node start up and the frontend will be available at ",(0,r.jsx)(n.a,{href:"http://localhost:8080",children:"http://localhost:8080"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Docker Setup Running",src:s(6481).A+"",width:"3016",height:"1194"})}),"\n",(0,r.jsx)(n.h3,{id:"debugging-docker-issues",children:"Debugging Docker Issues"}),"\n",(0,r.jsx)(n.p,{children:"To inspect the running container:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# View logs\ndocker logs <container-id>\n\n# Open a shell inside the container\ndocker exec -it <container-id> /bin/bash\n\n# Verify files exist\ndocker run --rm world-map-2d-sample ls -la /app/.docker-scripts/\ndocker run --rm world-map-2d-sample ls -la /app/packages/frontend/\n"})}),"\n",(0,r.jsx)(n.h2,{id:"the-components-in-action",children:"The Components in Action"}),"\n",(0,r.jsxs)(n.p,{children:["When you run ",(0,r.jsx)(n.code,{children:"deno task dev"})," for this template, the ",(0,r.jsx)(n.a,{href:"/docs/ja/home/components/processes",children:"Process Orchestrator"})," sets up a complete local environment:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hardhat EVM Node"}),": A local EVM blockchain running on port 8545."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Development Services"}),": The development database, log collector, TUI, and the Explorer."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Effectstream Node"}),": Backend service on port 9999 to sync the chain and process game logic."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Frontend"}),": A simple HTML/JavaScript interface on port 8080 for player interaction."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"on-chain-logic",children:"On-Chain Logic"}),"\n",(0,r.jsxs)(n.p,{children:["The world-map-2d template uses a ",(0,r.jsx)(n.code,{children:"Effectstream L2 Contract"})," deployed on the local EVM chain. This contract acts as an input mailbox - players submit formatted strings representing their actions, and Effectstream processes these inputs to update game state."]}),"\n",(0,r.jsxs)(n.p,{children:["The contract is deployed at ",(0,r.jsx)(n.code,{children:"0x5FbDB2315678afecb367f032d93F642f64180aa3"})," (local Hardhat deployment)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"// Simplified example of what the PaimaL2Contract does\ncontract PaimaL2 {\n    event PaimaGameInteraction(address indexed user, bytes input, uint256 indexed nonce);\n\n    function submitInput(bytes calldata input) external payable {\n        // Validates and stores the input\n        emit PaimaGameInteraction(msg.sender, input, nonce);\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Effectstream monitors the ",(0,r.jsx)(n.code,{children:"PaimaGameInteraction"})," event to receive player inputs."]}),"\n",(0,r.jsxs)(n.h2,{id:"the-state-machine-state-machinets",children:["The State Machine (",(0,r.jsx)(n.code,{children:"state-machine.ts"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:["The State Machine contains the core game logic. It uses ",(0,r.jsx)(n.strong,{children:"generator functions"})," with ",(0,r.jsx)(n.code,{children:"yield*"})," for structured effects, following the new Effectstream architecture pattern."]}),"\n",(0,r.jsx)(n.h3,{id:"grammar-definition",children:"Grammar Definition"}),"\n",(0,r.jsxs)(n.p,{children:["The input grammar is defined using TypeBox schemas in ",(0,r.jsx)(n.code,{children:"packages/shared/data-types/src/grammar.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'export const grammar = {\n  joinWorld: [],\n  submitMove: [\n    ["x", Type.Number({ minimum: 0, maximum: 9 })],\n    ["y", Type.Number({ minimum: 0, maximum: 9 })],\n  ],\n  submitIncrement: [\n    ["x", Type.Number({ minimum: 0, maximum: 9 })],\n    ["y", Type.Number({ minimum: 0, maximum: 9 })],\n  ],\n} as const satisfies GrammarDefinition;\n'})}),"\n",(0,r.jsx)(n.h3,{id:"state-transitions",children:"State Transitions"}),"\n",(0,r.jsx)(n.h4,{id:"joinworld",children:(0,r.jsx)(n.code,{children:"joinWorld"})}),"\n",(0,r.jsx)(n.p,{children:"Triggered when a player joins the world for the first time. Creates a user record and places them at the origin (0, 0)."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'stm.addStateTransition("joinWorld", function* (data) {\n  const { blockHeight, parsedInput, randomGenerator, signerAddress: user } = data;\n\n  const result = yield* World.promise<SQLUpdate>(\n    joinWorld(user!, blockHeight, { input: "joinWorld", ...parsedInput }, randomGenerator)\n  );\n\n  yield* printSQLQuery(result);\n  yield* World.resolve(result[0], result[1]);\n});\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"joinWorld"})," transition function in ",(0,r.jsx)(n.code,{children:"packages/client/node/src/state-machine/v1/transition.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const joinWorld = async (\n  player: WalletAddress,\n  blockHeight: number,\n  input: JoinWorldInput,\n  randomnessGenerator: Prando\n): Promise<SQLUpdate> => {\n  return persistNewUser(player);\n};\n\nfunction persistNewUser(wallet: WalletAddress): SQLUpdate {\n  const params = { wallet, x: 0, y: 0 };\n  return [createGlobalUserState, params];\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"submitmove",children:(0,r.jsx)(n.code,{children:"submitMove"})}),"\n",(0,r.jsx)(n.p,{children:"Allows players to move to any valid position on the 10\xd710 grid."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'stm.addStateTransition("submitMove", function* (data) {\n  const { blockHeight, parsedInput, randomGenerator, signerAddress: user } = data;\n\n  const result = yield* World.promise<SQLUpdate>(\n    submitMove(user!, blockHeight, { input: "submitMove", ...parsedInput }, randomGenerator)\n  );\n\n  yield* printSQLQuery(result);\n  yield* World.resolve(result[0], result[1]);\n});\n'})}),"\n",(0,r.jsx)(n.p,{children:"The move transition function:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const submitMove = async (\n  player: WalletAddress,\n  blockHeight: number,\n  input: SubmitMoveInput,\n  randomnessGenerator: Prando\n): Promise<SQLUpdate> => {\n  return persistUserPosition(player, input.x, input.y);\n};\n\nfunction persistUserPosition(\n  wallet: WalletAddress,\n  x: number,\n  y: number\n): SQLUpdate {\n  const params = { x, y, wallet };\n  return [updateUserGlobalPosition, params];\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Note: In this implementation, validation happens at the grammar level (TypeBox ensures ",(0,r.jsx)(n.code,{children:"0 \u2264 x \u2264 9"})," and ",(0,r.jsx)(n.code,{children:"0 \u2264 y \u2264 9"})," for the 10\xd710 grid). Additional validation could be added here if needed."]}),"\n",(0,r.jsx)(n.h4,{id:"submitincrement",children:(0,r.jsx)(n.code,{children:"submitIncrement"})}),"\n",(0,r.jsx)(n.p,{children:"Increments a counter at a specific world location, tracking how many times each cell has been visited."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'stm.addStateTransition("submitIncrement", function* (data) {\n  const { blockHeight, parsedInput, randomGenerator, signerAddress: user } = data;\n\n  const result = yield* World.promise<SQLUpdate>(\n    submitIncrement(user!, blockHeight, { input: "submitIncrement", ...parsedInput }, randomGenerator)\n  );\n\n  yield* printSQLQuery(result);\n  yield* World.resolve(result[0], result[1]);\n});\n'})}),"\n",(0,r.jsx)(n.p,{children:"The increment transition function:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const submitIncrement = async (\n  player: WalletAddress,\n  blockHeight: number,\n  input: SubmitIncrementInput,\n  randomnessGenerator: Prando\n): Promise<SQLUpdate> => {\n  return persistWorldCount(input.x, input.y);\n};\n\nfunction persistWorldCount(x: number, y: number): SQLUpdate {\n  const params = { x, y };\n  return [updateWorldStateCounter, params];\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"database-schema",children:"Database Schema"}),"\n",(0,r.jsxs)(n.p,{children:["The database has two main tables defined in ",(0,r.jsx)(n.code,{children:"packages/client/database/src/migrations/database.sql"}),":"]}),"\n",(0,r.jsx)(n.h3,{id:"global_user_state",children:(0,r.jsx)(n.code,{children:"global_user_state"})}),"\n",(0,r.jsx)(n.p,{children:"Stores each player's current position in the world."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE global_user_state (\n  wallet TEXT NOT NULL PRIMARY KEY,\n  x INTEGER NOT NULL,\n  y INTEGER NOT NULL\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"global_world_state",children:(0,r.jsx)(n.code,{children:"global_world_state"})}),"\n",(0,r.jsx)(n.p,{children:"Tracks statistics for each cell in the 10\xd710 grid."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE global_world_state (\n  x INTEGER NOT NULL,\n  y INTEGER NOT NULL,\n  counter INTEGER NOT NULL DEFAULT 0,\n  can_visit BOOLEAN NOT NULL DEFAULT TRUE,\n  PRIMARY KEY (x, y)\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"The world state is pre-populated with all 100 cells (0-9 in both x and y) during initialization."}),"\n",(0,r.jsx)(n.h3,{id:"type-safe-queries",children:"Type-Safe Queries"}),"\n",(0,r.jsxs)(n.p,{children:["The template uses ",(0,r.jsx)(n.strong,{children:"pgtyped"})," to generate TypeScript types from SQL queries. Query files are in ",(0,r.jsx)(n.code,{children:"packages/client/database/src/sql/"}),":"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"select.sql"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"/* @name getUserStats */\nSELECT * FROM global_user_state\nWHERE wallet = :wallet;\n\n/* @name getAllWorldStats */\nSELECT * FROM global_world_state\nWHERE can_visit = TRUE;\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"insert.sql"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"/* @name createGlobalUserState */\nINSERT INTO global_user_state (wallet, x, y)\nVALUES (:wallet!, :x!, :y!);\n\n/* @name createGlobalWorldState */\nINSERT INTO global_world_state (x, y, counter, can_visit)\nVALUES (:x!, :y!, :counter!, :can_visit!);\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"update.sql"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"/* @name updateUserGlobalPosition */\nUPDATE global_user_state\nSET x = :x!, y = :y!\nWHERE wallet = :wallet!;\n\n/* @name updateWorldStateCounter */\nUPDATE global_world_state\nSET counter = counter + 1\nWHERE x = :x! AND y = :y!;\n"})}),"\n",(0,r.jsx)(n.p,{children:"To regenerate types after modifying SQL files:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"cd packages/client/database\nnpm install\nnpx pgtyped -c ./pgtypedconfig.json\n"})}),"\n",(0,r.jsx)(n.h2,{id:"api-endpoints",children:"API Endpoints"}),"\n",(0,r.jsxs)(n.p,{children:["The backend server runs on ",(0,r.jsx)(n.strong,{children:"port 9999"})," and provides REST endpoints defined in ",(0,r.jsx)(n.code,{children:"packages/client/node/src/api.ts"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["All database queries are wrapped in ",(0,r.jsx)(n.code,{children:"runPreparedQuery"})," from ",(0,r.jsx)(n.code,{children:"@paimaexample/db"}),". This is required because PGlite (the in-memory database) only allows single-threaded access. The ",(0,r.jsx)(n.code,{children:"runPreparedQuery"})," function uses a semaphore to coordinate access to the single database connection across multiple processes."]}),"\n",(0,r.jsxs)(n.h3,{id:"get-user_statswalletaddress",children:["GET ",(0,r.jsx)(n.code,{children:"/user_stats?wallet=<address>"})]}),"\n",(0,r.jsx)(n.p,{children:"Fetches the current position of a player."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Query Parameters"}),":"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Parameter"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Type"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Required"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"wallet"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"string"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Yes"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"The wallet address of the user"})]})})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example Request"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl "http://localhost:9999/user_stats?wallet=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example Response"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "wallet_address": "0xf39fd6e51aad88f6f4ce6ab8827279cffb92266",\n  "x": 5,\n  "y": 3\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Returns ",(0,r.jsx)(n.code,{children:"null"})," if the user hasn't joined the world yet."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Implementation"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'server.get("/user_stats", async (request, reply) => {\n  const { wallet } = request.query as { wallet: string };\n  if (!wallet) {\n    return reply.code(400).send({ error: "wallet parameter required" });\n  }\n\n  try {\n    const [userStats] = await runPreparedQuery(\n      getUserStats.run({ wallet }, dbConn),\n      "getUserStats"\n    );\n    return reply.send(userStats || null);\n  } catch (error) {\n    console.error("Error fetching user stats:", error);\n    return reply.code(500).send({ error: "Internal server error" });\n  }\n});\n'})}),"\n",(0,r.jsxs)(n.h3,{id:"get-world_stats",children:["GET ",(0,r.jsx)(n.code,{children:"/world_stats"})]}),"\n",(0,r.jsx)(n.p,{children:"Fetches all world cell statistics (100 cells in the 10\xd710 grid)."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example Request"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl "http://localhost:9999/world_stats"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example Response"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'[\n  { "x": 0, "y": 0, "counter": 5, "can_visit": true },\n  { "x": 0, "y": 1, "counter": 2, "can_visit": true },\n  { "x": 0, "y": 2, "counter": 0, "can_visit": true },\n  ...\n]\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Implementation"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'server.get("/world_stats", async (request, reply) => {\n  try {\n    const worldStats = await runPreparedQuery(\n      getAllWorldStats.run(undefined, dbConn),\n      "getAllWorldStats"\n    );\n    return reply.send(worldStats);\n  } catch (error) {\n    console.error("Error fetching world stats:", error);\n    return reply.code(500).send({ error: "Internal server error" });\n  }\n});\n'})}),"\n",(0,r.jsx)(n.h2,{id:"frontend-architecture",children:"Frontend Architecture"}),"\n",(0,r.jsxs)(n.p,{children:["The frontend uses a simple HTML/JavaScript approach with wallet integration via ",(0,r.jsx)(n.code,{children:"@paimaexample/wallets"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"wallet-middleware",children:"Wallet Middleware"}),"\n",(0,r.jsxs)(n.p,{children:["The frontend includes a middleware layer (",(0,r.jsx)(n.code,{children:"paimaMiddleware.src.js"}),") that bridges the HTML interface to the Effectstream wallet API:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'import { PaimaEngineConfig, sendTransaction, walletLogin, WalletMode } from "@paimaexample/wallets";\nimport { hardhat } from "viem/chains";\n\nconst paimaEngineConfig = new PaimaEngineConfig(\n  "world-map-2d",\n  "mainEvmRPC",\n  "0x5FbDB2315678afecb367f032d93F642f64180aa3",\n  hardhat,\n  undefined,\n  undefined,\n  false,\n);\n\nconst endpoints = {\n  async userWalletLogin({ mode, preferBatchedMode }) {\n    const result = await walletLogin({\n      mode: mode || WalletMode.EvmInjected,\n      chain: paimaEngineConfig.paimaL2Chain,\n      preferBatchedMode: preferBatchedMode ?? false,\n    });\n    if (!result.success) throw new Error("Wallet login failed");\n    wallet = result.result;\n    return wallet;\n  },\n\n  async joinWorld() {\n    const result = await sendTransaction(wallet, ["joinWorld"], paimaEngineConfig);\n    return result;\n  },\n\n  async submitMoves(x, y) {\n    const result = await sendTransaction(wallet, ["submitMove", x, y], paimaEngineConfig);\n    return result;\n  },\n\n  async submitIncrement(x, y) {\n    const result = await sendTransaction(wallet, ["submitIncrement", x, y], paimaEngineConfig);\n    return result;\n  },\n};\n\nwindow.paimaMiddleware = endpoints;\n'})}),"\n",(0,r.jsxs)(n.p,{children:["This middleware is bundled using esbuild into ",(0,r.jsx)(n.code,{children:"paimaMiddleware.js"})," which the HTML page loads."]}),"\n",(0,r.jsx)(n.h3,{id:"building-the-frontend",children:"Building the Frontend"}),"\n",(0,r.jsx)(n.p,{children:"The frontend uses esbuild with Node.js polyfills for browser compatibility:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'import { nodeModulesPolyfillPlugin } from "esbuild-plugins-node-modules-polyfill";\nimport { build } from "esbuild";\n\nbuild({\n  entryPoints: ["./paimaMiddleware.src.js"],\n  bundle: true,\n  outfile: "paimaMiddleware.js",\n  sourcemap: true,\n  plugins: [\n    nodeModulesPolyfillPlugin({\n      globals: { process: true, Buffer: true },\n    }),\n  ],\n});\n'})}),"\n",(0,r.jsx)(n.h2,{id:"architecture-highlights",children:"Architecture Highlights"}),"\n",(0,r.jsx)(n.h3,{id:"generator-function-pattern",children:"Generator Function Pattern"}),"\n",(0,r.jsxs)(n.p,{children:["State transitions use ",(0,r.jsx)(n.strong,{children:"generator functions"})," with ",(0,r.jsx)(n.code,{children:"yield*"})," for structured effects, following Effectstream's coroutine-based architecture:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function* (data) {\n  // 1. Call transition function (returns a Promise<SQLUpdate>)\n  const result = yield* World.promise<SQLUpdate>(\n    transitionFunction(...)\n  );\n\n  // 2. Apply the SQL update\n  yield* World.resolve(result[0], result[1]);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"This pattern ensures:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Deterministic execution"}),": All side effects are managed by the Effectstream runtime"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Testability"}),": Transition functions return SQL update descriptions rather than executing queries directly"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Simplicity"}),": Each transition returns a single update operation"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"separation-of-concerns",children:"Separation of Concerns"}),"\n",(0,r.jsx)(n.p,{children:"The template follows a clean architecture:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Grammar"})," (",(0,r.jsx)(n.code,{children:"packages/shared/data-types"}),"): Input validation using TypeBox"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Transition Functions"})," (",(0,r.jsx)(n.code,{children:"packages/client/node/src/state-machine/v1/transition.ts"}),"): Async functions that return SQL updates"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"State Machine"})," (",(0,r.jsx)(n.code,{children:"packages/client/node/src/state-machine.ts"}),"): Orchestrates transitions with Effectstream using generator functions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Database"})," (",(0,r.jsx)(n.code,{children:"packages/client/database"}),"): Type-safe queries with pgtyped"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"API"})," (",(0,r.jsx)(n.code,{children:"packages/client/node/src/api.ts"}),"): REST endpoints for the frontend"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Frontend"})," (",(0,r.jsx)(n.code,{children:"packages/frontend"}),"): Simple HTML/JS interface"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"use-cases-and-extensions",children:"Use Cases and Extensions"}),"\n",(0,r.jsx)(n.p,{children:"This template can be extended for various game types:"}),"\n",(0,r.jsx)(n.h3,{id:"exploration-games",children:"Exploration Games"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Add items or collectibles at specific locations"}),"\n",(0,r.jsx)(n.li,{children:"Implement fog of war (cells revealed as players visit them)"}),"\n",(0,r.jsx)(n.li,{children:"Create quest markers and waypoints"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"territory-control",children:"Territory Control"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Allow players to claim cells"}),"\n",(0,r.jsx)(n.li,{children:"Implement resource gathering per cell"}),"\n",(0,r.jsx)(n.li,{children:"Add building/construction mechanics"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"multiplayer-interactions",children:"Multiplayer Interactions"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Show other players in the same cell"}),"\n",(0,r.jsx)(n.li,{children:"Implement chat or trading at shared locations"}),"\n",(0,r.jsx)(n.li,{children:"Add PvP zones or safe zones"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"puzzle-games",children:"Puzzle Games"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Create movement-based puzzles"}),"\n",(0,r.jsx)(n.li,{children:"Implement pressure plates or switches"}),"\n",(0,r.jsx)(n.li,{children:"Add teleportation mechanics between cells"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"port-conflicts",children:"Port Conflicts"}),"\n",(0,r.jsx)(n.p,{children:"If ports 8545, 9999, or 8080 are already in use:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# Check what's using the ports\nlsof -i :8545\nlsof -i :9999\nlsof -i :8080\n\n# Kill processes if needed\nkill -9 <PID>\n"})}),"\n",(0,r.jsx)(n.h3,{id:"frontend-bundle-outdated",children:"Frontend Bundle Outdated"}),"\n",(0,r.jsxs)(n.p,{children:["If you modify ",(0,r.jsx)(n.code,{children:"paimaMiddleware.src.js"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"cd packages/frontend\nnode esbuild.js  # Regenerate paimaMiddleware.js\n"})}),"\n",(0,r.jsx)(n.h3,{id:"database-query-types-out-of-sync",children:"Database Query Types Out of Sync"}),"\n",(0,r.jsx)(n.p,{children:"If you modify SQL files, regenerate types:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"cd packages/client/database\nnpm install\nnpx pgtyped -c ./pgtypedconfig.json\n"})}),"\n",(0,r.jsx)(n.h2,{id:"learn-more",children:"Learn More"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"../200-state-machine/index.md",children:"Effectstream State Machine Guide"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"../300-primitives/index.md",children:"Multi-Chain Primitives"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/ja/home/components/processes",children:"Process Orchestrator"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/ja/home/templates/chess",children:"Chess Template"})," - For turn-based game patterns"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/ja/home/templates/evm-midnight",children:"EVM-Midnight Template"})," - For multi-chain examples"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},6481:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1206-docker-0af6642a8b3b2f7ae525f287c27360a5.png"},6613:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>a});var t=s(1491);const r={},i=t.createContext(r);function l(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(i.Provider,{value:n},e.children)}},9605:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1206-gameplay-03757d5dffa39a90a37a0ad17253fa9c.png"}}]);