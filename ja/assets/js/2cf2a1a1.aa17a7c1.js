"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[8626],{4298:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"home/effectstream-engine/database","title":"Database","description":"At the heart of every Effectstream node is a powerful PostgreSQL database. This database is the single source of truth for your application\'s state, storing everything from raw on-chain inputs to the processed, real-time state of your game world.","source":"@site/docs/home/1000-effectstream-engine/1002-database.md","sourceDirName":"home/1000-effectstream-engine","slug":"/home/effectstream-engine/database","permalink":"/docs/ja/home/effectstream-engine/database","draft":false,"unlisted":false,"editUrl":"https://github.com/PaimaStudios/paima-engine-docs/tree/main/docs/home/1000-effectstream-engine/1002-database.md","tags":[],"version":"current","sidebarPosition":1002,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Architecture","permalink":"/docs/ja/home/effectstream-engine/"},"next":{"title":"Contributing to Effectstream","permalink":"/docs/ja/home/effectstream-engine/contributions"}}');var i=s(2531),r=s(6613);const a={},o="Database",l={},c=[{value:"Database Schema",id:"database-schema",level:3},{value:"Defining Custom Tables &amp; Migrations",id:"defining-custom-tables--migrations",level:3},{value:"Creating Migration Files",id:"creating-migration-files",level:3},{value:"Type-Safe Queries with <code>pgtyped</code>",id:"type-safe-queries-with-pgtyped",level:3},{value:"Writing Named Queries",id:"writing-named-queries",level:3},{value:"Generating TypeScript Functions",id:"generating-typescript-functions",level:3},{value:"System Tables Overview",id:"system-tables-overview",level:3}];function d(e){const t={a:"a",code:"code",h1:"h1",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"database",children:"Database"})}),"\n",(0,i.jsx)(t.p,{children:"At the heart of every Effectstream node is a powerful PostgreSQL database. This database is the single source of truth for your application's state, storing everything from raw on-chain inputs to the processed, real-time state of your game world."}),"\n",(0,i.jsx)(t.p,{children:"Effectstream provides a sophisticated and developer-friendly toolkit for defining your database schema, managing its evolution over time, and interacting with it in a type-safe manner."}),"\n",(0,i.jsx)(t.h3,{id:"database-schema",children:"Database Schema"}),"\n",(0,i.jsx)(t.p,{children:"Your dApp's database is organized into three main schemas:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"paima"})}),": This schema is reserved for Effectstream's internal system tables. These tables manage the core operations of the node, such as block processing, input queuing, account management, and achievement tracking. You should generally not modify these tables directly."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"primitives"})}),": This schema holds the ",(0,i.jsx)(t.strong,{children:"Dynamic Tables"})," that are automatically created and managed by the Effectstream to represent the state of your configured Primitives. For example, an ",(0,i.jsx)(t.code,{children:"ERC20"})," primitive will create a table in this schema to track token balances."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"public"})}),": This is ",(0,i.jsx)(t.strong,{children:"your schema"}),". All of your dApp's custom tables, such as ",(0,i.jsx)(t.code,{children:"players"}),", ",(0,i.jsx)(t.code,{children:"games"}),", or ",(0,i.jsx)(t.code,{children:"inventories"}),", should be created here."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["In development, you can opt into ",(0,i.jsx)(t.code,{children:"config.dev.resetPublicData"})," to truncate every table in ",(0,i.jsx)(t.code,{children:"public"})," (sequences reset) right after the startup DB mutex is acquired and before migrations or sync run. ",(0,i.jsx)(t.strong,{children:"Only use this on development"}),". See ",(0,i.jsx)(t.a,{href:"/docs/ja/home/components/node-startup#development-reset-option-configdevresetpublicdata",children:"Node Startup"})," for details."]}),"\n",(0,i.jsx)(t.h3,{id:"defining-custom-tables--migrations",children:"Defining Custom Tables & Migrations"}),"\n",(0,i.jsxs)(t.p,{children:["The process of defining and evolving your database schema is managed through a robust ",(0,i.jsx)(t.strong,{children:"migration system"}),". A migration is simply a SQL file containing ",(0,i.jsx)(t.code,{children:"CREATE TABLE"}),", ",(0,i.jsx)(t.code,{children:"ALTER TABLE"}),", or other DDL statements."]}),"\n",(0,i.jsx)(t.h3,{id:"creating-migration-files",children:"Creating Migration Files"}),"\n",(0,i.jsxs)(t.p,{children:["All your SQL migration files should be placed in the ",(0,i.jsx)(t.code,{children:"/packages/node-sdk/db/migrations/system-down-v-x.x.x.sql"})," directory."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsxs)(t.strong,{children:["Example (",(0,i.jsx)(t.code,{children:"system-down-v-x.x.x.sql"}),"):"]})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE effectstream.system_table (\n  id SERIAL PRIMARY KEY,\n  block_height INTEGER NOT NULL,\n  ...other fields...\n);\n"})}),"\n",(0,i.jsxs)(t.h3,{id:"type-safe-queries-with-pgtyped",children:["Type-Safe Queries with ",(0,i.jsx)(t.code,{children:"pgtyped"})]}),"\n",(0,i.jsxs)(t.p,{children:["Effectstream uses ",(0,i.jsx)(t.code,{children:"pgtyped"})," to bridge the gap between your SQL database and your TypeScript code. It automatically generates fully type-safe TypeScript functions directly from your raw SQL queries, eliminating an entire class of bugs and providing excellent editor autocompletion."]}),"\n",(0,i.jsx)(t.h3,{id:"writing-named-queries",children:"Writing Named Queries"}),"\n",(0,i.jsxs)(t.p,{children:["You write your SQL queries in files within the ",(0,i.jsx)(t.code,{children:"/TODO"})," directory. To make a query available to ",(0,i.jsx)(t.code,{children:"pgtyped"}),", you must give it a special named comment."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsxs)(t.strong,{children:["Example (",(0,i.jsx)(t.code,{children:"TODO.sql"}),"):"]})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"-- TODO\n"})}),"\n",(0,i.jsx)(t.h3,{id:"generating-typescript-functions",children:"Generating TypeScript Functions"}),"\n",(0,i.jsx)(t.p,{children:"After writing your queries, you run a simple command:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sh",children:"deno task -f @effectstream/db pgtyped:update\n"})}),"\n",(0,i.jsx)(t.p,{children:"This command introspects your SQL files and your database schema, then generates corresponding TypeScript functions."}),"\n",(0,i.jsx)(t.h3,{id:"system-tables-overview",children:"System Tables Overview"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"paima"})," schema contains a number of tables essential for the engine's operation. Here are a few of the most important ones:"]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Table"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"paima.effectstream_blocks"})})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Records every L2 block processed by the engine, including its seed for randomness."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"paima.rollup_inputs"})})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"A queue for all incoming inputs from on-chain events."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"paima.rollup_input_future_block"})})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Stores scheduled inputs that are set to execute at a future block height (for timers/ticks)."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsxs)(t.strong,{children:[(0,i.jsx)(t.code,{children:"paima.accounts"})," & ",(0,i.jsx)(t.code,{children:"paima.addresses"})]})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Manages the L2 Account System, linking wallets to persistent accounts."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"paima.achievement_progress"})})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Stores the dynamic per-player progress for the PRC-1 Achievement system."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"paima.primitive_config"})})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Stores the configuration of all your defined Primitives."})]})]})]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},6613:(e,t,s)=>{s.d(t,{R:()=>a,x:()=>o});var n=s(1491);const i={},r=n.createContext(i);function a(e){const t=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(r.Provider,{value:t},e.children)}}}]);